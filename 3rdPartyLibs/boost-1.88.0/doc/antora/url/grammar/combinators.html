<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Compound Rules :: Boost Libraries Documentation</title>
  <link rel="canonical" href="https://antora.cppalliance.org/master/lib/doc/url/grammar/combinators.html">
    <link rel="prev" href="charset.html">
    <link rel="next" href="range.html">
  <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../_/css/boostlook.css">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <script>var uiRootPath = '../../_'</script>
<link rel="icon" href="../../_/img/favicons/favicon.ico" type="image/x-icon">
    <!-- Favicon configuration -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../_/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="../../_/img/favicons/site.webmanifest">
    <link rel="shortcut icon" href="../../_/img/favicons/favicon.ico">
  </head>
  <body class="article toc2 toc-left">
    <div class="boostlook">
  <div id="header">
    <div id="toc" class="nav-container toc2" data-component="url" data-version="">
  <aside class="nav">
    <button class="nav-close"></button>
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
      <h3 class="title"><a href="../index.html">Boost.URL</a></h3>
      <ul class="nav-list">
        <ul class="nav-list">
        <li class="" data-depth="1">
            <a class="nav-link" href="../quicklook.html">Quick Look</a>
        </li>
              <li class="" data-depth="1">
            <a class="nav-link" href="../urls/index.html">URLs</a>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../urls/parsing.html">Parsing</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/containers.html">Containers</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/segments.html">Segments</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/params.html">Params</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/normalization.html">Normalization</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/stringtoken.html">String Token</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/percent-encoding.html">Percent Encoding</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../urls/formatting.html">Formatting</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <a class="nav-link" href="index.html">Customization</a>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="rules.html">Parse Rules</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="charset.html">Character Sets</a>
        </li>
              <li class=" is-current-page" data-depth="2">
            <a class="nav-link" href="combinators.html">Compound Rules</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="range.html">Ranges</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="rfc3986.html">RFC 3986</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <span class="nav-text">Examples</span>
        </li>
        <ul class="nav-list">
        <li class="" data-depth="2">
            <a class="nav-link" href="../examples/qrcode.html">QR Code</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../examples/finicky.html">Finicky</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../examples/mailto.html">mailto URLs</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../examples/magnet-link.html">Magnet Link</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../examples/file-router.html">File Router</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../examples/router.html">Router</a>
        </li>
              <li class="" data-depth="2">
            <a class="nav-link" href="../examples/sanitize.html">Sanitizing URLs</a>
        </li>
        </ul>
        <li class="" data-depth="1">
            <a class="nav-link" href="../reference.html">Reference</a>
        </li>
              <li class="" data-depth="1">
            <a class="nav-link" href="../HelpCard.html">Help Card</a>
        </li>
        </ul>
  </ul>
  </nav>
</div>
    </div>
  </aside>
</div>
</div>
  <div id="content">
    <article class="doc max-width-reset">
  <div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>
      <a href="../index.html" aria-label="Home: Boost.URL">
        <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 -960 960 960" fill="#000000" aria-hidden="true"><path d="M160-120v-480l320-240 320 240v480H560v-280H400v280H160Z"/></svg>
      </a>
    </li>
    <li><a href="index.html">Customization</a></li>
    <li><a href="combinators.html">Compound Rules</a></li>
  </ul>
</nav>
<div class="spirit-nav">
    <a accesskey="p" href="charset.html"><span class="material-symbols-outlined" title="Previous: Character Sets">arrow_back</span></a>
    <a accesskey="p" href="index.html"><span class="material-symbols-outlined" title="Up: Customization">arrow_upward</span></a>
    <a accesskey="p" href="range.html"><span class="material-symbols-outlined" title="Next: Ranges">arrow_forward</span></a>
</div>
</div>
    <h1 class="page">Compound Rules</h1>
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The rules shown so far have defined
<a href="https://en.wikipedia.org/wiki/Terminal_and_nonterminal_symbols" target="blank_"><em>terminal symbols</em></a>, representing indivisible units of grammar.
To parse more complex things, a
<a href="https://en.wikipedia.org/wiki/Parser_combinator" target="blank_"><em>parser combinator</em></a>
(or <em>compound rule</em>) is a rule which accepts as parameters one or more rules and combines them to form a higher order algorithm.
In this section we introduce the compound rules provided by the library, and how they may be used to express more complex grammars.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tuple_rule"><a class="anchor" href="#_tuple_rule"></a>Tuple Rule</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider the following grammar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">version = "v" dec-octet "." dec-octet</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can express this using <code><a href="../reference/boost/urls/grammar/tuple_rule.html" class="xref page">tuple_rule</a></code>, which matches one or more specified rules in sequence.
The folllowing defines a sequence using some character literals and two decimal octets, which is a fancy way of saying a number between 0 and 255:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">constexpr auto version_rule = tuple_rule( delim_rule( 'v' ), dec_octet_rule, delim_rule( '.' ), dec_octet_rule );</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rule has a value type of <code><a href="https://en.cppreference.com/w/cpp/utility/tuple" target="_blank" rel="noopener">std::tuple</a></code>, whose types correspond to the value type of each rule specified upon construction.
The decimal octets are represented by the <code><a href="../reference/boost/urls/grammar/dec_octet_rule.html" class="xref page">dec_octet_rule</a></code> which stores its result in an cpp:unsigned char[]:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">system::result&lt; std::tuple&lt; core::string_view, unsigned char, core::string_view, unsigned char &gt; &gt; rv = parse( "v42.44800", version_rule );</code></pre>
</div>
</div>
<div class="paragraph">
<p>To extract elements from <code><a href="https://en.cppreference.com/w/cpp/utility/tuple" target="_blank" rel="noopener">std::tuple</a></code> the function <code>std::get</code>
must be used.
In this case, we don&#8217;t care to know the value for the matching character literals.
The <code><a href="../reference/boost/urls/grammar/tuple_rule.html" class="xref page">tuple_rule</a></code> discards match results whose value type is <code><a href="https://en.cppreference.com/w/cpp/language/types#void" target="_blank" rel="noopener">void</a></code>.
We can use the <code><a href="../reference/boost/urls/grammar/squelch.html" class="xref page">squelch</a></code>
compound rule to convert a matching value type to <code><a href="https://en.cppreference.com/w/cpp/language/types#void" target="_blank" rel="noopener">void</a></code>, and reformulate our rule:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">constexpr auto version_rule = tuple_rule( squelch( delim_rule( 'v' ) ), dec_octet_rule, squelch( delim_rule( '.' ) ), dec_octet_rule );

system::result&lt; std::tuple&lt; unsigned char, unsigned char &gt; &gt; rv = parse( "v42.44800", version_rule );</code></pre>
</div>
</div>
<div class="paragraph">
<p>When all but one of the value types is <code><a href="https://en.cppreference.com/w/cpp/language/types#void" target="_blank" rel="noopener">void</a></code>, the <code><a href="https://en.cppreference.com/w/cpp/utility/tuple" target="_blank" rel="noopener">std::tuple</a></code> is elided and the remaining value type is promoted to the result of the match:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// port     = ":" unsigned-short

constexpr auto port_rule = tuple_rule( squelch( delim_rule( ':' ) ), unsigned_rule&lt; unsigned short &gt;{} );

system::result&lt; unsigned short &gt; rv = parse( ":443", port_rule );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optional_rule"><a class="anchor" href="#_optional_rule"></a>Optional Rule</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BNF elements in brackets denote optional components.
These are expressed using <code><a href="../reference/boost/urls/grammar/optional_rule.html" class="xref page">optional_rule</a></code>, whose value type is an
<code><a href="../reference/boost/urls/optional.html" class="xref page">optional</a></code>.
For example, we can adapt the port rule from above to be an optional component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// port     = [ ":" unsigned-short ]

constexpr auto port_rule = optional_rule( tuple_rule( squelch( delim_rule( ':' ) ), unsigned_rule&lt; unsigned short &gt;{} ) );

system::result&lt; boost::optional&lt; unsigned short &gt; &gt; rv = parse( ":8080", port_rule );

assert( rv-&gt;has_value() &amp;&amp; rv-&gt;value() == 8080 );</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we build up a rule to represent an endpoint as an IPv4 address with an optional port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// ipv4_address = dec-octet "." dec-octet "." dec-octet "." dec-octet
//
// port         = ":" unsigned-short
//
// endpoint     = ipv4_address [ port ]

constexpr auto endpoint_rule = tuple_rule(
    tuple_rule(
        dec_octet_rule, squelch( delim_rule( '.' ) ),
        dec_octet_rule, squelch( delim_rule( '.' ) ),
        dec_octet_rule, squelch( delim_rule( '.' ) ),
        dec_octet_rule ),
    optional_rule(
        tuple_rule(
            squelch( delim_rule( ':' ) ),
            unsigned_rule&lt; unsigned short &gt;{} ) ) );</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be simplified; the library provides <code><a href="../reference/boost/urls/ipv4_address_rule.html" class="xref page">ipv4_address_rule</a></code>
whose result type is <code><a href="../reference/boost/urls/ipv4_address.html" class="xref page">ipv4_address</a></code>, offering more utility than representing the address simply as a collection of four numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">constexpr auto endpoint_rule = tuple_rule(
    ipv4_address_rule,
    optional_rule(
        tuple_rule(
            squelch( delim_rule( ':' ) ),
            unsigned_rule&lt; unsigned short &gt;{} ) ) );

system::result&lt; std::tuple&lt; ipv4_address, boost::optional&lt; unsigned short &gt; &gt; &gt; rv = parse( "192.168.0.1:443", endpoint_rule );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_variant_rule"><a class="anchor" href="#_variant_rule"></a>Variant Rule</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BNF elements separated by unquoted slashes represent a set of alternatives from which one element may match.
We represent them using <code><a href="../reference/boost/urls/grammar/variant_rule.html" class="xref page">variant_rule</a></code>, whose value type is a variant.
Consider the following HTTP production rule which comes from
<a href="https://datatracker.ietf.org/doc/html/rfc7230#section-5.3"" target="blank_">rfc7230</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">request-target = origin-form
                / absolute-form
                / authority-form
                / asterisk-form</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>request-target</em> can be exactly one of these things.
Here we define the rule, using <code><a href="../reference/boost/urls/origin_form_rule.html" class="xref page">origin_form_rule</a></code>, <code><a href="../reference/boost/urls/absolute_uri_rule.html" class="xref page">absolute_uri_rule</a></code>, and <code><a href="../reference/boost/urls/authority_rule.html" class="xref page">authority_rule</a></code> which come with the library, and obtain a result from parsing a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">constexpr auto request_target_rule = variant_rule(
    origin_form_rule,
    absolute_uri_rule,
    authority_rule,
    delim_rule('*') );

system::result&lt; variant2::variant&lt; url_view, url_view, authority_view, core::string_view &gt; &gt; rv = parse( "/results.htm?page=4", request_target_rule );</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next section we discuss facilities to parse a repeating number of elements.</p>
</div>
</div>
</div>
  <div class="edit-this-page">
      <a href="https://github.com/boostorg/url/edit/develop/doc/modules/ROOT/pages/grammar/combinators.adoc">Edit this Page</a>
      </div>
      <nav class="pagination">
        <span class="prev"><a href="charset.html">Character Sets</a></span>
        <span class="next"><a href="range.html">Ranges</a></span>
    </nav>
</article>
</div>
  <div id="footer">
  <script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
</div>
</div>
  </body>
</html>
