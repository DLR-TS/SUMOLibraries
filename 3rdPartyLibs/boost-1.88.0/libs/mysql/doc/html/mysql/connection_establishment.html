<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Connection establishment and termination</title>
<link rel="stylesheet" href="../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../index.html" title="Chapter 1. Boost.MySQL">
<link rel="up" href="../index.html" title="Chapter 1. Boost.MySQL">
<link rel="prev" href="overview.html" title="Overview">
<link rel="next" href="text_queries.html" title="Text queries and client-side SQL formatting">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../boost.png"></td>
<td align="center"><a href="../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="overview.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="text_queries.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="mysql.connection_establishment"></a><a class="link" href="connection_establishment.html" title="Connection establishment and termination">Connection establishment
    and termination</a>
</h2></div></div></div>
<p>
      This section discusses several aspects regarding the creation, establishment
      and termination of client connections.
    </p>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.authentication"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.authentication" title="Authentication">Authentication</a>
</h3></div></div></div>
<p>
        <a class="link" href="ref/boost__mysql__connect_params/username.html" title="connect_params::username"><code class="literal">connect_params::username</code></a>
        and <a class="link" href="ref/boost__mysql__connect_params/password.html" title="connect_params::password"><code class="literal">connect_params::password</code></a>
        contain the credentials used during authentication. The password is sent
        to the server either hashed or over a secure channel such as TLS, as mandated
        by the protocol.
      </p>
<p>
        MySQL implements several authentication plugins that can be used to authenticate
        a user (see the <a href="https://dev.mysql.com/doc/refman/8.0/en/pluggable-authentication.html" target="_top">pluggable
        authentication MySQL docs</a>). Each MySQL user is associated to a single
        authentication plugin, specified during using creation. Additionally, servers
        define a default authentication plugin (see <a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_authentication_policy" target="_top"><code class="computeroutput"><span class="identifier">authentication_policy</span></code></a> and <a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_default_authentication_plugin" target="_top"><code class="computeroutput"><span class="identifier">default_authentication_plugin</span></code></a>).
        The default plugin will be used for newly created users, and may affect how
        the handshake works.
      </p>
<p>
        This library implements the two most common authentication plugins:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
            <a href="https://dev.mysql.com/doc/refman/8.0/en/native-pluggable-authentication.html" target="_top"><code class="computeroutput"><span class="identifier">mysql_native_password</span></code></a>. Unless
            otherwise configured, this is the default plugin for MySQL 5.7 and MariaDB.
            It can be used over both TLS and plaintext connections. It sends the
            password hashed, salted by a nonce.
          </li>
<li class="listitem">
            <a href="https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html" target="_top"><code class="computeroutput"><span class="identifier">caching_sha2_password</span></code></a>. This
            is the default plugin for MySQL 8.0+. It can only be used over secure
            transports, like TCP with TLS or UNIX sockets.
          </li>
</ul></div>
<p>
        Multi-factor authentication is not yet supported. If you require support
        for a plugin not listed above or for MFA, please file a feature request against
        the GitHub repository.
      </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../../../../doc/src/images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
          Servers configured with a default authentication plugin not implemented
          in Boost.MySQL are not supported, regardless of the actual plugin the concrete
          user employs. This limitation may be lifted in the future.
        </p></td></tr>
</table></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.connect_with_database"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.connect_with_database" title="Connect with database">Connect
      with database</a>
</h3></div></div></div>
<p>
        <a class="link" href="ref/boost__mysql__connect_params/database.html" title="connect_params::database"><code class="literal">connect_params::database</code></a>
        contains the database name to connect to. If you specify it, your connection
        will default to use that database, as if you had issued a <a href="https://dev.mysql.com/doc/refman/8.0/en/use.html" target="_top"><code class="computeroutput"><span class="identifier">USE</span></code></a> statement. You can leave it
        blank to select no database. You can always issue a <a href="https://dev.mysql.com/doc/refman/8.0/en/use.html" target="_top"><code class="computeroutput"><span class="identifier">USE</span></code></a> statement using <a class="link" href="ref/boost__mysql__any_connection/async_execute.html" title="any_connection::async_execute"><code class="literal">async_execute</code></a>
        to select a different database after establishing the connection.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.tls"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.tls" title="TLS support">TLS support</a>
</h3></div></div></div>
<p>
        TLS encrypted connections are fully supported by Boost.MySQL. TCP connections
        established using <a class="link" href="ref/boost__mysql__any_connection.html" title="any_connection"><code class="literal">any_connection</code></a>
        use TLS by default.
      </p>
<h5>
<a name="mysql.connection_establishment.tls.h0"></a>
        <span class="phrase"><a name="mysql.connection_establishment.tls.tls_handshake_and_termination"></a></span><a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.tls_handshake_and_termination">TLS
        handshake and termination</a>
      </h5>
<p>
        The TLS handshake is performed by <a class="link" href="ref/boost__mysql__any_connection/async_connect.html" title="any_connection::async_connect"><code class="literal">any_connection::async_connect</code></a>.
        This contrasts with libraries like <a href="../../../../../libs/beast/index.html" target="_top">Boost.Beast</a>,
        where the TLS handshake must be explicitly invoked by the user. We selected
        this approach because the TLS handshake is part of the MySQL protocol's handshake:
        the client and server exchange several unencrypted messages, then perform
        the TLS handshake and continue exchanging encrypted messages, until the connection
        either succeeds or fails. This scheme enables the TLS negotiation feature
        (see below for more info).
      </p>
<p>
        If the TLS handshake fails, the entire <a class="link" href="ref/boost__mysql__any_connection/async_connect.html" title="any_connection::async_connect"><code class="literal">async_connect</code></a>
        operation will also fail.
      </p>
<p>
        TLS shutdown is performed by <a class="link" href="ref/boost__mysql__any_connection/async_close.html" title="any_connection::async_close"><code class="literal">any_connection::async_close</code></a>.
        MySQL doesn't always close TLS connections gracefully, so errors generated
        by the TLS shutdown are ignored.
      </p>
<h5>
<a name="mysql.connection_establishment.tls.h1"></a>
        <span class="phrase"><a name="mysql.connection_establishment.tls.negotiation"></a></span><a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.negotiation">TLS
        negotiation</a>
      </h5>
<p>
        During connection establishment, client and server negotiate whether to use
        TLS or not. Boost.MySQL supports such negotiation using <a class="link" href="ref/boost__mysql__connect_params/ssl.html" title="connect_params::ssl"><code class="literal">connect_params::ssl</code></a>.
        This is a <a class="link" href="ref/boost__mysql__ssl_mode.html" title="ssl_mode"><code class="literal">ssl_mode</code></a>
        enum with the following options:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
            <code class="computeroutput"><span class="identifier">ssl_mode</span><span class="special">::</span><span class="identifier">enable</span></code> will make the connection use
            TLS if the server supports it, falling back to a plaintext connection
            otherwise. <span class="bold"><strong>This is the default</strong></span> for
            <a class="link" href="ref/boost__mysql__any_connection.html" title="any_connection"><code class="literal">any_connection</code></a>
            when using TCP.
          </li>
<li class="listitem">
            <code class="computeroutput"><span class="identifier">ssl_mode</span><span class="special">::</span><span class="identifier">require</span></code> ensures that the connection
            uses TLS. If the server does not support it, <a class="link" href="ref/boost__mysql__any_connection/async_connect.html" title="any_connection::async_connect"><code class="literal">async_connect</code></a>
            fails.
          </li>
<li class="listitem">
            <code class="computeroutput"><span class="identifier">ssl_mode</span><span class="special">::</span><span class="identifier">disable</span></code> unconditionally disables TLS.
          </li>
</ul></div>
<p>
        <span class="bold"><strong>UNIX sockets</strong></span> are considered secure channels
        and <span class="bold"><strong>never use TLS</strong></span>. When connecting using
        a UNIX socket, <a class="link" href="ref/boost__mysql__connect_params/ssl.html" title="connect_params::ssl"><code class="literal">connect_params::ssl</code></a>
        is ignored.
      </p>
<p>
        After a successful connection establishment, you can use <a class="link" href="ref/boost__mysql__any_connection/uses_ssl.html" title="any_connection::uses_ssl"><code class="literal">any_connection::uses_ssl</code></a>
        to query whether the connection is encrypted or not.
      </p>
<h5>
<a name="mysql.connection_establishment.tls.h2"></a>
        <span class="phrase"><a name="mysql.connection_establishment.tls.disabling_tls"></a></span><a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.disabling_tls">Disabling
        TLS</a>
      </h5>
<p>
        As mentioned above, setting <a class="link" href="ref/boost__mysql__connect_params/ssl.html" title="connect_params::ssl"><code class="literal">connect_params::ssl</code></a>
        to <code class="computeroutput"><span class="identifier">ssl_mode</span><span class="special">::</span><span class="identifier">disable</span></code> disables TLS:
      </p>
<pre class="programlisting"><span class="comment">// The server host, username, password and database to use.</span>
<span class="comment">// Passing ssl_mode::disable will disable the use of TLS.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connect_params</span> <span class="identifier">params</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">server_address</span><span class="special">.</span><span class="identifier">emplace_host_and_port</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="identifier">server_hostname</span><span class="special">));</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">username</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">username</span><span class="special">);</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">password</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">password</span><span class="special">);</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">database</span> <span class="special">=</span> <span class="string">"boost_mysql_examples"</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">ssl</span> <span class="special">=</span> <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">ssl_mode</span><span class="special">::</span><span class="identifier">disable</span><span class="special">;</span>
</pre>
<p>
        See the <a class="link" href="examples/disable_tls.html" title="Disabling TLS for a connection">full example here</a>.
      </p>
<h5>
<a name="mysql.connection_establishment.tls.h3"></a>
        <span class="phrase"><a name="mysql.connection_establishment.tls.options"></a></span><a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.options">Certificate
        validation and other TLS options</a>
      </h5>
<p>
        You can pass an optional <a href="../../../../../doc/html/boost_asio/reference/ssl__context.html" target="_top"><code class="literal">asio::ssl::context</code></a>
        to <a class="link" href="ref/boost__mysql__any_connection.html" title="any_connection"><code class="literal">any_connection</code></a>
        constructor. You can set many TLS parameters doing this, including trusted
        CAs, certificate validation callbacks and TLS extensions.
      </p>
<p>
        <a class="link" href="ref/boost__mysql__any_connection_params.html" title="any_connection_params"><code class="literal">any_connection_params</code></a>
        contains a <a class="link" href="ref/boost__mysql__any_connection_params/ssl_context.html" title="any_connection_params::ssl_context"><code class="literal">ssl_context</code></a>
        member that can be used for this. For example, TLS certificate validation
        is disabled by default. To enable it:
      </p>
<pre class="programlisting"><span class="comment">// Create a SSL context, which contains TLS configuration options</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">ssl</span><span class="special">::</span><span class="identifier">context</span> <span class="identifier">ssl_ctx</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ssl</span><span class="special">::</span><span class="identifier">context</span><span class="special">::</span><span class="identifier">tls_client</span><span class="special">);</span>

<span class="comment">// Enable certificate verification. If the server's certificate</span>
<span class="comment">// is not valid or not signed by a trusted CA, async_connect will error.</span>
<span class="identifier">ssl_ctx</span><span class="special">.</span><span class="identifier">set_verify_mode</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ssl</span><span class="special">::</span><span class="identifier">verify_peer</span><span class="special">);</span>

<span class="comment">// Load a trusted CA, which was used to sign the server's certificate.</span>
<span class="comment">// This will allow the signature verification to succeed in our example.</span>
<span class="comment">// You will have to run your MySQL server with the test certificates</span>
<span class="comment">// located under $BOOST_MYSQL_ROOT/tools/ssl/</span>
<span class="comment">// If you want to use your system's trusted CAs, use</span>
<span class="comment">// ssl::context::set_default_verify_paths() instead of this function.</span>
<span class="identifier">ssl_ctx</span><span class="special">.</span><span class="identifier">add_certificate_authority</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">buffer</span><span class="special">(</span><span class="identifier">CA_PEM</span><span class="special">));</span>

<span class="comment">// We expect the server certificate's common name to be "mysql".</span>
<span class="comment">// If it's not, the certificate will be rejected and handshake or connect will fail.</span>
<span class="comment">// Replace "mysql" by the common name you expect.</span>
<span class="identifier">ssl_ctx</span><span class="special">.</span><span class="identifier">set_verify_callback</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ssl</span><span class="special">::</span><span class="identifier">host_name_verification</span><span class="special">(</span><span class="string">"mysql"</span><span class="special">));</span>

<span class="comment">// Create a connection.</span>
<span class="comment">// We pass the context as the second argument to the connection's constructor.</span>
<span class="comment">// Other TLS options can be also configured using this approach.</span>
<span class="comment">// We need to keep ssl_ctx alive as long as we use the connection.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">any_connection</span> <span class="identifier">conn</span><span class="special">(</span><span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">this_coro</span><span class="special">::</span><span class="identifier">executor</span><span class="special">,</span> <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">any_connection_params</span><span class="special">{&amp;</span><span class="identifier">ssl_ctx</span><span class="special">});</span>

<span class="comment">// The hostname, username, password and database to use</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connect_params</span> <span class="identifier">params</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">server_address</span><span class="special">.</span><span class="identifier">emplace_host_and_port</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="identifier">server_hostname</span><span class="special">));</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">username</span> <span class="special">=</span> <span class="identifier">username</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">password</span> <span class="special">=</span> <span class="identifier">password</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">database</span> <span class="special">=</span> <span class="string">"boost_mysql_examples"</span><span class="special">;</span>

<span class="comment">// Connect to the server. If certificate verification fails,</span>
<span class="comment">// async_connect will fail.</span>
<span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">.</span><span class="identifier">async_connect</span><span class="special">(</span><span class="identifier">params</span><span class="special">);</span>
</pre>
<p>
        You can safely share a single <a href="../../../../../doc/html/boost_asio/reference/ssl__context.html" target="_top"><code class="literal">asio::ssl::context</code></a>
        among several connections.
      </p>
<p>
        If no <code class="computeroutput"><span class="identifier">ssl</span><span class="special">::</span><span class="identifier">context</span></code> is passed, one will be internally
        created by the connection when required. The default context doesn't perform
        certificate validation.
      </p>
<p>
        The full source code for the above example is <a class="link" href="examples/tls_certificate_verification.html" title="Setting TLS options: enabling TLS certificate verification">here</a>.
      </p>
<h5>
<a name="mysql.connection_establishment.tls.h4"></a>
        <span class="phrase"><a name="mysql.connection_establishment.tls.tls_in_connection_pool"></a></span><a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.tls_in_connection_pool">TLS in
        connection_pool</a>
      </h5>
<p>
        Since <a class="link" href="ref/boost__mysql__connection_pool.html" title="connection_pool"><code class="literal">connection_pool</code></a>
        creates <a class="link" href="ref/boost__mysql__any_connection.html" title="any_connection"><code class="literal">any_connection</code></a>
        instances, the mechanics for TLS are similar. TLS-related parameters are
        specified during pool construction, as members of <a class="link" href="ref/boost__mysql__pool_params.html" title="pool_params"><code class="literal">pool_params</code></a>:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
            <a class="link" href="ref/boost__mysql__pool_params/ssl.html" title="pool_params::ssl"><code class="literal">pool_params::ssl</code></a>
            controls TLS negotiation. It's a <a class="link" href="ref/boost__mysql__ssl_mode.html" title="ssl_mode"><code class="literal">ssl_mode</code></a>
            value, with the semantics explained <a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.negotiation">above</a>.
          </li>
<li class="listitem">
            <a class="link" href="ref/boost__mysql__pool_params/ssl_ctx.html" title="pool_params::ssl_ctx"><code class="literal">pool_params::ssl_ctx</code></a>
            is a <a href="../../../../../doc/html/boost_asio/reference/ssl__context.html" target="_top"><code class="literal">asio::ssl::context</code></a>
            that is passed to connections created by the pool. It can be used to
            configure <a class="link" href="connection_establishment.html#mysql.connection_establishment.tls.options">TLS
            options</a> like certificate verification. The pool takes ownership
            of the passed <code class="computeroutput"><span class="identifier">ssl</span><span class="special">::</span><span class="identifier">context</span></code>, as opposed to <code class="computeroutput"><span class="identifier">any_connection</span></code>.
          </li>
</ul></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.unix"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.unix" title="UNIX sockets">UNIX sockets</a>
</h3></div></div></div>
<p>
        <a class="link" href="ref/boost__mysql__connect_params/server_address.html" title="connect_params::server_address"><code class="literal">connect_params::server_address</code></a>
        is an <a class="link" href="ref/boost__mysql__any_address.html" title="any_address"><code class="literal">any_address</code></a>,
        a variant-like type that can hold a (hostname, port) pair or a UNIX socket
        path. To connect to MySQL using a UNIX socket, set <code class="computeroutput"><span class="identifier">server_address</span></code>
        to a UNIX domain path:
      </p>
<pre class="programlisting"><span class="comment">// Create a connection.</span>
<span class="comment">// Will use the same executor as the coroutine.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">any_connection</span> <span class="identifier">conn</span><span class="special">(</span><span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">this_coro</span><span class="special">::</span><span class="identifier">executor</span><span class="special">);</span>

<span class="comment">// The socket path, username, password and database to use.</span>
<span class="comment">// server_address is a variant-like type. Using emplace_unix_path,</span>
<span class="comment">// we can specify a UNIX socket path, instead of a hostname and a port.</span>
<span class="comment">// UNIX socket connections never use TLS.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connect_params</span> <span class="identifier">params</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">server_address</span><span class="special">.</span><span class="identifier">emplace_unix_path</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="identifier">unix_socket_path</span><span class="special">));</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">username</span> <span class="special">=</span> <span class="identifier">username</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">password</span> <span class="special">=</span> <span class="identifier">password</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">database</span> <span class="special">=</span> <span class="string">"boost_mysql_examples"</span><span class="special">;</span>

<span class="comment">// Connect to the server</span>
<span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">.</span><span class="identifier">async_connect</span><span class="special">(</span><span class="identifier">params</span><span class="special">);</span>
</pre>
<p>
        Note that UNIX sockets never use TLS, regardless of the value of <a class="link" href="ref/boost__mysql__connect_params/ssl.html" title="connect_params::ssl"><code class="literal">connect_params::ssl</code></a>.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.changing_the_network_buffer_size"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.changing_the_network_buffer_size" title="Changing the network buffer size limit">Changing
      the network buffer size limit</a>
</h3></div></div></div>
<p>
        <a class="link" href="ref/boost__mysql__any_connection.html" title="any_connection"><code class="literal">any_connection</code></a>
        owns an internal network buffer used to store messages that are to be written
        or have been read from the server. Its initial size is given by <a class="link" href="ref/boost__mysql__any_connection_params/initial_buffer_size.html" title="any_connection_params::initial_buffer_size"><code class="literal">any_connection_params::initial_buffer_size</code></a>.
        Every protocol message needs to fit in memory, so the buffer is expanded
        as required. When reading data, every row is sent as an individual message.
      </p>
<p>
        The buffer never resizes past <a class="link" href="ref/boost__mysql__any_connection_params/max_buffer_size.html" title="any_connection_params::max_buffer_size"><code class="literal">any_connection_params::max_buffer_size</code></a>.
        If an operation requires a bigger buffer, it will fail with the <code class="computeroutput"><span class="identifier">client_errc</span><span class="special">::</span><span class="identifier">max_buffer_size_exceeded</span></code> error code. The
        default size is 64MB.
      </p>
<p>
        If you need to read or write individual rows bigger than the default limit,
        you can increase it when constructing the connection:
      </p>
<pre class="programlisting"><span class="comment">// Increase the max buffer size to 512MB.</span>
<span class="comment">// This allows reading individual rows as big as 512MB.</span>
<span class="comment">// This is only required if each individual row is extremely big,</span>
<span class="comment">// and is not required for many smaller rows.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">any_connection_params</span> <span class="identifier">conn_params</span><span class="special">;</span>
<span class="identifier">conn_params</span><span class="special">.</span><span class="identifier">max_buffer_size</span> <span class="special">=</span> <span class="number">0x20000000</span><span class="special">;</span>

<span class="comment">// Create the connection</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">any_connection</span> <span class="identifier">conn</span><span class="special">(</span><span class="identifier">ctx</span><span class="special">,</span> <span class="identifier">conn_params</span><span class="special">);</span>

<span class="comment">// Connect and use the connection normally</span>
</pre>
<p>
        Note that reading datasets bigger than 64MB <span class="bold"><strong>does not
        require increasing the limit</strong></span> as long as individual rows are smaller
        than the aforementioned limit.
      </p>
<p>
        Tweaking <a class="link" href="ref/boost__mysql__any_connection_params/initial_buffer_size.html" title="any_connection_params::initial_buffer_size"><code class="literal">any_connection_params::initial_buffer_size</code></a>
        may affect <a class="link" href="ref/boost__mysql__any_connection/async_read_some_rows.html" title="any_connection::async_read_some_rows"><code class="literal">any_connection::async_read_some_rows</code></a>
        performance, as explained in <a class="link" href="multi_function.html#mysql.multi_function.read_some_rows">this
        section</a>.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.enabling_multi_queries"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.enabling_multi_queries" title="Enabling multi-queries">Enabling
      multi-queries</a>
</h3></div></div></div>
<p>
        You can run several several semicolon-separated queries at once using <a class="link" href="ref/boost__mysql__any_connection/async_execute.html" title="any_connection::async_execute"><code class="literal">any_connection::async_execute</code></a>.
        This is a protocol feature that is disabled by default. You can enable it
        by setting <a class="link" href="ref/boost__mysql__connect_params/multi_queries.html" title="connect_params::multi_queries"><code class="literal">connect_params::multi_queries</code></a>
        to true before connecting:
      </p>
<pre class="programlisting"><span class="comment">// The server host, username, password and database to use.</span>
<span class="comment">// Setting multi_queries to true makes it possible to run several</span>
<span class="comment">// semicolon-separated queries with async_execute.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connect_params</span> <span class="identifier">params</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">server_address</span><span class="special">.</span><span class="identifier">emplace_host_and_port</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="identifier">server_hostname</span><span class="special">));</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">username</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">username</span><span class="special">);</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">password</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">password</span><span class="special">);</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">database</span> <span class="special">=</span> <span class="string">"boost_mysql_examples"</span><span class="special">;</span>
<span class="identifier">params</span><span class="special">.</span><span class="identifier">multi_queries</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>

<span class="comment">// Connect to the server</span>
<span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">.</span><span class="identifier">async_connect</span><span class="special">(</span><span class="identifier">params</span><span class="special">);</span>
</pre>
<p>
        As explained <a class="link" href="tutorial_updates_transactions.html" title="Tutorial 5: UPDATEs, transactions and semicolon-separated queries">in the tutorial</a>,
        multi-separated queries are useful in a number of cases, like when using
        transactions. <a class="link" href="multi_resultset.html#mysql.multi_resultset.multi_queries">This section</a>
        contains more info on how to use multi-queries.
      </p>
<p>
        This protocol feature is disabled by default as a security hardening measure.
        If your application contains a SQL injection vulnerability, this feature
        can make exploiting it easier. Applications that don't need this feature
        should leave it off as a best practice.
      </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../../../../doc/src/images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
          Using multi-queries correctly is secure. Just make sure to use the adequate
          client-side SQL formatting tools to generate queries securely.
        </p></td></tr>
</table></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.closing_a_connection"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.closing_a_connection" title="Closing a connection">Closing
      a connection</a>
</h3></div></div></div>
<p>
        You can cleanly close a connection by calling <a class="link" href="ref/boost__mysql__any_connection/async_close.html" title="any_connection::async_close"><code class="literal">any_connection::async_close</code></a>.
        This sends a <span class="emphasis"><em>quit packet</em></span> to the server, notifying that
        we're about to end the connection, performs TLS shutdown, and closes the
        underlying transport. A clean close involves I/O and can thus fail.
      </p>
<p>
        <span class="bold"><strong>Destroying the connection</strong></span> without performing
        a clean close will just close the underlying transport. <span class="bold"><strong>It
        won't leak any resource</strong></span>, but you might see warnings in the server
        log. Try to close connections cleanly when possible.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.connection_establishment.reconnection_and_long_lived_conn"></a><a class="link" href="connection_establishment.html#mysql.connection_establishment.reconnection_and_long_lived_conn" title="Reconnection and long-lived connections">Reconnection
      and long-lived connections</a>
</h3></div></div></div>
<p>
        <a class="link" href="ref/boost__mysql__any_connection.html" title="any_connection"><code class="literal">any_connection</code></a>
        doesn't perform any re-connection on its own. If a fatal error (like a network
        error) is encountered during an operation, you need to re-establish the connection
        explicitly.
      </p>
<p>
        By design, <a class="link" href="ref/boost__mysql__any_connection/async_connect.html" title="any_connection::async_connect"><code class="literal">any_connection::async_connect</code></a>
        can <span class="bold"><strong>always be used</strong></span> to re-establish connections.
        It works even after the connection encountered a network error or a cancellation.
        To achieve this, <code class="computeroutput"><span class="identifier">async_connect</span></code>
        will wipe any previous connection state before proceeding.
      </p>
<p>
        If you need reliable, long-lived connections, consider <a class="link" href="connection_pool.html" title="Connection pools">using
        a connection pool</a> instead of rolling out your own strategy. <code class="computeroutput"><span class="identifier">connection_pool</span></code> takes care of re-connecting
        and re-using connections for you.
      </p>
</div>
</div>
<div class="copyright-footer">Copyright © 2019-2024 Ruben Perez<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="overview.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="text_queries.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
