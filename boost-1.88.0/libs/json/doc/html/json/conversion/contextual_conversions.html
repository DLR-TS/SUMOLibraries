<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Contextual conversions</title>
<link rel="stylesheet" href="../../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../../index.html" title="Chapter 1. Boost.JSON">
<link rel="up" href="../conversion.html" title="Value Conversion">
<link rel="prev" href="allocation_control.html" title="Allocation control">
<link rel="next" href="avoiding_physical_dependency.html" title="Avoiding physical dependency">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="allocation_control.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../conversion.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="avoiding_physical_dependency.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="json.conversion.contextual_conversions"></a><a class="link" href="contextual_conversions.html" title="Contextual conversions">Contextual conversions</a>
</h3></div></div></div>
<p>
        Previously in this section we've been assuming that there is a particular
        fitting JSON representation for a type. But this is not always the case.
        Often one needs to represent particular value with JSON of certain format
        in one situation and with another format in a different situation. This can
        be achieved with Boost.JSON by providing an extra argument—context.
      </p>
<p>
        Let's implement conversion from <code class="computeroutput"><span class="identifier">user_ns</span><span class="special">::</span><span class="identifier">ip_address</span></code>
        to a JSON string:
      </p>
<pre class="programlisting"><span class="keyword">namespace</span> <span class="identifier">user_ns</span>
<span class="special">{</span>

<span class="keyword">struct</span> <span class="identifier">as_string</span>
<span class="special">{</span> <span class="special">};</span>

<span class="keyword">void</span>
<span class="identifier">tag_invoke</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from_tag</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value</span><span class="special">&amp;</span> <span class="identifier">jv</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">ip_address</span><span class="special">&amp;</span> <span class="identifier">addr</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">as_string</span><span class="special">&amp;</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">js</span> <span class="special">=</span> <span class="identifier">jv</span><span class="special">.</span><span class="identifier">emplace_string</span><span class="special">();</span>
    <span class="identifier">js</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span> <span class="number">4</span> <span class="special">*</span> <span class="number">3</span> <span class="special">+</span> <span class="number">3</span> <span class="special">+</span> <span class="number">1</span> <span class="special">);</span> <span class="comment">// XXX.XXX.XXX.XXX\0</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">addr</span><span class="special">.</span><span class="identifier">begin</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">n</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">sprintf</span><span class="special">(</span>
        <span class="identifier">js</span><span class="special">.</span><span class="identifier">data</span><span class="special">(),</span> <span class="string">"%hhu.%hhu.%hhu.%hhu"</span><span class="special">,</span> <span class="identifier">it</span><span class="special">[</span><span class="number">0</span><span class="special">],</span> <span class="identifier">it</span><span class="special">[</span><span class="number">1</span><span class="special">],</span> <span class="identifier">it</span><span class="special">[</span><span class="number">2</span><span class="special">],</span> <span class="identifier">it</span><span class="special">[</span><span class="number">3</span><span class="special">]</span> <span class="special">);</span>
    <span class="identifier">js</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span><span class="identifier">n</span><span class="special">);</span>
<span class="special">}</span>

<span class="identifier">ip_address</span>
<span class="identifier">tag_invoke</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_to_tag</span><span class="special">&lt;</span><span class="identifier">ip_address</span><span class="special">&gt;,</span> <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value</span><span class="special">&amp;</span> <span class="identifier">jv</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">as_string</span><span class="special">&amp;</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">js</span> <span class="special">=</span> <span class="identifier">jv</span><span class="special">.</span><span class="identifier">as_string</span><span class="special">();</span>

    <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="identifier">octets</span><span class="special">[</span><span class="number">4</span><span class="special">];</span>
    <span class="keyword">int</span> <span class="identifier">result</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">sscanf</span><span class="special">(</span>
        <span class="identifier">js</span><span class="special">.</span><span class="identifier">data</span><span class="special">(),</span> <span class="string">"%hhu.%hhu.%hhu.%hhu"</span><span class="special">,</span> <span class="identifier">octets</span><span class="special">,</span> <span class="identifier">octets</span> <span class="special">+</span> <span class="number">1</span><span class="special">,</span> <span class="identifier">octets</span> <span class="special">+</span> <span class="number">2</span><span class="special">,</span> <span class="identifier">octets</span> <span class="special">+</span> <span class="number">3</span> <span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span> <span class="identifier">result</span> <span class="special">!=</span> <span class="number">4</span> <span class="special">)</span>
        <span class="keyword">throw</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">invalid_argument</span><span class="special">(</span><span class="string">"not an IP address"</span><span class="special">);</span>

    <span class="keyword">return</span> <span class="identifier">ip_address</span><span class="special">(</span> <span class="identifier">octets</span><span class="special">[</span><span class="number">0</span><span class="special">],</span> <span class="identifier">octets</span><span class="special">[</span><span class="number">1</span><span class="special">],</span> <span class="identifier">octets</span><span class="special">[</span><span class="number">2</span><span class="special">],</span> <span class="identifier">octets</span><span class="special">[</span><span class="number">3</span><span class="special">]</span> <span class="special">);</span>
<span class="special">}</span>

<span class="special">}</span>
</pre>
<p>
        These <code class="computeroutput"><span class="identifier">tag_invoke</span></code> overloads
        take an extra <code class="computeroutput"><span class="identifier">as_string</span></code> parameter,
        which disambiguates this specific representation of <code class="computeroutput"><span class="identifier">ip_address</span></code>
        from all other potential representations. In order to take advantage of them
        one needs to pass an <code class="computeroutput"><span class="identifier">as_string</span></code>
        object to <a class="link" href="../ref/boost__json__value_from.html" title="value_from"><code class="computeroutput"><span class="identifier">value_from</span></code></a> or <a class="link" href="../ref/boost__json__value_to.html" title="value_to"><code class="computeroutput"><span class="identifier">value_to</span></code></a> as the last argument:
      </p>
<pre class="programlisting"><span class="identifier">ip_address</span> <span class="identifier">addr</span><span class="special">(</span> <span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">11</span> <span class="special">);</span>

<span class="identifier">value</span> <span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">addr</span><span class="special">,</span> <span class="identifier">as_string</span><span class="special">()</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span><span class="identifier">R</span><span class="string">"( "</span><span class="number">192.168</span><span class="special">.</span><span class="number">10.11</span><span class="string">" )"</span><span class="special">)</span> <span class="special">);</span>

<span class="identifier">ip_address</span> <span class="identifier">addr2</span> <span class="special">=</span> <span class="identifier">value_to</span><span class="special">&lt;</span> <span class="identifier">ip_address</span> <span class="special">&gt;(</span> <span class="identifier">jv</span><span class="special">,</span> <span class="identifier">as_string</span><span class="special">()</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">equal</span><span class="special">(</span>
    <span class="identifier">addr</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">addr</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="identifier">addr2</span><span class="special">.</span><span class="identifier">begin</span><span class="special">()</span> <span class="special">));</span>
</pre>
<p>
        Note, that if there is no dedicated <code class="computeroutput"><span class="identifier">tag_invoke</span></code>
        overload for a given type and a given context, the implementation falls back
        to overloads without context. Thus it is easy to combine contextual conversions
        with conversions provided by the library:
      </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">,</span> <span class="identifier">ip_address</span> <span class="special">&gt;</span> <span class="identifier">computers</span> <span class="special">=</span> <span class="special">{</span>
    <span class="special">{</span> <span class="string">"Alex"</span><span class="special">,</span> <span class="special">{</span> <span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">1</span><span class="special">,</span> <span class="number">1</span> <span class="special">}</span> <span class="special">},</span>
    <span class="special">{</span> <span class="string">"Blake"</span><span class="special">,</span> <span class="special">{</span> <span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">1</span><span class="special">,</span> <span class="number">2</span> <span class="special">}</span> <span class="special">},</span>
    <span class="special">{</span> <span class="string">"Carol"</span><span class="special">,</span> <span class="special">{</span> <span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">1</span><span class="special">,</span> <span class="number">3</span> <span class="special">}</span> <span class="special">},</span>
<span class="special">};</span>
<span class="identifier">value</span> <span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">computers</span><span class="special">,</span> <span class="identifier">as_string</span><span class="special">()</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span>
    <span class="string">"{                               "</span>
    <span class="string">"    \"Alex\" : \"192.168.1.1\", "</span>
    <span class="string">"    \"Blake\": \"192.168.1.2\", "</span>
    <span class="string">"    \"Carol\": \"192.168.1.3\"  "</span>
    <span class="string">"}                               "</span>
    <span class="special">)</span> <span class="special">);</span>
</pre>
<h5>
<a name="json.conversion.contextual_conversions.h0"></a>
        <span class="phrase"><a name="json.conversion.contextual_conversions.conversions_for_third_party_type"></a></span><a class="link" href="contextual_conversions.html#json.conversion.contextual_conversions.conversions_for_third_party_type">Conversions
        for third-party types</a>
      </h5>
<p>
        Normally, you wouldn't be able to provide conversions for types from third-party
        libraries and standard types, because it would require yout to put <code class="computeroutput"><span class="identifier">tag_invoke</span></code> overloads into namespaces you
        do not control. But with contexts you can put the overloads into your namespaces.
        This is because the context will add its associated namespaces into the list
        of namespaces where <code class="computeroutput"><span class="identifier">tag_invoke</span></code>
        overloads are searched.
      </p>
<p>
        As an example, let's implement conversion for <a href="https://en.cppreference.com/w/cpp/chrono/system_clock" target="_top"><code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span></code>s</a>
        using <a href="https://en.wikipedia.org/wiki/ISO_8601" target="_top">ISO 8601</a>
        format.
      </p>
<pre class="programlisting"><span class="keyword">namespace</span> <span class="identifier">user_ns</span>
<span class="special">{</span>

<span class="keyword">struct</span> <span class="identifier">as_iso_8601</span>
<span class="special">{</span> <span class="special">};</span>

<span class="keyword">void</span>
<span class="identifier">tag_invoke</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from_tag</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value</span><span class="special">&amp;</span> <span class="identifier">jv</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span> <span class="identifier">tp</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">as_iso_8601</span><span class="special">&amp;</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">js</span> <span class="special">=</span> <span class="identifier">jv</span><span class="special">.</span><span class="identifier">emplace_string</span><span class="special">();</span>
    <span class="identifier">js</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span> <span class="number">4</span> <span class="special">+</span> <span class="number">2</span> <span class="special">*</span> <span class="number">5</span> <span class="special">+</span> <span class="number">5</span> <span class="special">+</span> <span class="number">1</span> <span class="special">);</span> <span class="comment">// YYYY-mm-ddTHH:MM:ss\0</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">time_t</span> <span class="identifier">t</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">to_time_t</span><span class="special">(</span> <span class="identifier">tp</span> <span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">tm</span> <span class="identifier">tm</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">gmtime</span><span class="special">(</span> <span class="special">&amp;</span><span class="identifier">t</span> <span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">n</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">strftime</span><span class="special">(</span>
        <span class="identifier">js</span><span class="special">.</span><span class="identifier">data</span><span class="special">(),</span> <span class="identifier">js</span><span class="special">.</span><span class="identifier">size</span><span class="special">(),</span> <span class="string">"%FT%T"</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">tm</span> <span class="special">);</span>
    <span class="identifier">js</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span><span class="identifier">n</span><span class="special">);</span>
<span class="special">}</span>

<span class="special">}</span>
</pre>
<p>
        Reverse conversion is left out for brevity.
      </p>
<p>
        The new context is used in a similar fashion to <code class="computeroutput"><span class="identifier">as_string</span></code>
        previously in this section.
      </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span> <span class="identifier">tp</span><span class="special">;</span>
<span class="identifier">value</span> <span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">tp</span><span class="special">,</span> <span class="identifier">as_iso_8601</span><span class="special">()</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span><span class="identifier">R</span><span class="string">"( "</span><span class="number">1970</span><span class="special">-</span><span class="number">01</span><span class="special">-</span><span class="number">01</span><span class="identifier">T00</span><span class="special">:</span><span class="number">00</span><span class="special">:</span><span class="number">00</span><span class="string">" )"</span><span class="special">)</span> <span class="special">);</span>
</pre>
<p>
        One particular use case that is enabled by contexts is adaptor libraries
        that define JSON conversion logic for types from a different library.
      </p>
<h5>
<a name="json.conversion.contextual_conversions.h1"></a>
        <span class="phrase"><a name="json.conversion.contextual_conversions.passing_data_to_conversion_funct"></a></span><a class="link" href="contextual_conversions.html#json.conversion.contextual_conversions.passing_data_to_conversion_funct">Passing
        data to conversion functions</a>
      </h5>
<p>
        Contexts we used so far were empty classes. But contexts may have data members
        and member functions just as any class. Implementers of conversion functions
        can take advantage of that to have conversions configurable at runtime or
        pass special objects to conversions (e.g. allocators).
      </p>
<p>
        Let's rewrite conversion for <code class="computeroutput"><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span></code>s
        to allow any format supported by <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">strftime</span></code>.
      </p>
<pre class="programlisting"><span class="keyword">namespace</span> <span class="identifier">user_ns</span>
<span class="special">{</span>

<span class="keyword">struct</span> <span class="identifier">date_format</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">format</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">buffer_size</span><span class="special">;</span>
<span class="special">};</span>

<span class="keyword">void</span>
<span class="identifier">tag_invoke</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from_tag</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value</span><span class="special">&amp;</span> <span class="identifier">jv</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span> <span class="identifier">tp</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">date_format</span><span class="special">&amp;</span> <span class="identifier">ctx</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">js</span> <span class="special">=</span> <span class="identifier">jv</span><span class="special">.</span><span class="identifier">emplace_string</span><span class="special">();</span>
    <span class="identifier">js</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span> <span class="identifier">ctx</span><span class="special">.</span><span class="identifier">buffer_size</span> <span class="special">);</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">time_t</span> <span class="identifier">t</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">to_time_t</span><span class="special">(</span> <span class="identifier">tp</span> <span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">n</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">strftime</span><span class="special">(</span>
        <span class="identifier">js</span><span class="special">.</span><span class="identifier">data</span><span class="special">(),</span> <span class="identifier">js</span><span class="special">.</span><span class="identifier">size</span><span class="special">(),</span> <span class="identifier">ctx</span><span class="special">.</span><span class="identifier">format</span><span class="special">.</span><span class="identifier">c_str</span><span class="special">(),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">gmtime</span><span class="special">(</span> <span class="special">&amp;</span><span class="identifier">t</span> <span class="special">)</span> <span class="special">);</span>
    <span class="identifier">js</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span><span class="identifier">n</span><span class="special">);</span>
<span class="special">}</span>

<span class="special">}</span>
</pre>
<p>
        This <code class="computeroutput"><span class="identifier">tag_invoke</span></code> overload
        lets us change date conversion format at runtime. Also note, that there is
        no ambiguity between <code class="computeroutput"><span class="identifier">as_iso_8601</span></code>
        overload and <code class="computeroutput"><span class="identifier">date_format</span></code>
        overload. You can use both in your program:
      </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span> <span class="identifier">tp</span><span class="special">;</span>

<span class="identifier">value</span> <span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">tp</span><span class="special">,</span> <span class="identifier">date_format</span><span class="special">{</span> <span class="string">"%T %D"</span><span class="special">,</span> <span class="number">18</span> <span class="special">}</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span><span class="identifier">R</span><span class="string">"( "</span><span class="number">00</span><span class="special">:</span><span class="number">00</span><span class="special">:</span><span class="number">00</span> <span class="number">01</span><span class="special">/</span><span class="number">01</span><span class="special">/</span><span class="number">70</span><span class="string">" )"</span><span class="special">)</span> <span class="special">);</span>

<span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">tp</span><span class="special">,</span> <span class="identifier">as_iso_8601</span><span class="special">()</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span><span class="identifier">R</span><span class="string">"( "</span><span class="number">1970</span><span class="special">-</span><span class="number">01</span><span class="special">-</span><span class="number">01</span><span class="identifier">T00</span><span class="special">:</span><span class="number">00</span><span class="special">:</span><span class="number">00</span><span class="string">" )"</span><span class="special">)</span> <span class="special">);</span>
</pre>
<h5>
<a name="json.conversion.contextual_conversions.h2"></a>
        <span class="phrase"><a name="json.conversion.contextual_conversions.combining_contexts"></a></span><a class="link" href="contextual_conversions.html#json.conversion.contextual_conversions.combining_contexts">Combining
        contexts</a>
      </h5>
<p>
        Often it is needed to use several conversion contexts together. For example,
        consider a log of remote users identified by IP addresses accessing a system.
        We can represent it as <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span><span class="special">,</span> <span class="identifier">ip_address</span>
        <span class="special">&gt;</span> <span class="special">&gt;</span></code>.
        We want to serialize both <code class="computeroutput"><span class="identifier">ip_address</span></code>es
        and <code class="computeroutput"><span class="identifier">time_point</span></code>s as strings,
        but for this we need both <code class="computeroutput"><span class="identifier">as_string</span></code>
        and <code class="computeroutput"><span class="identifier">as_iso_8601</span></code> contexts.
        To combine several contexts just use <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span></code>.
        Conversion functions will select the first element of the tuple for which
        a <code class="computeroutput"><span class="identifier">tag_invoke</span></code> overload exists
        and will call that overload. As usual, <code class="computeroutput"><span class="identifier">tag_invoke</span></code>
        overloads that don't use contexts and library-provided generic conversions
        are also supported. Thus, here's our example:
      </p>
<pre class="programlisting"><span class="keyword">using</span> <span class="identifier">time_point</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">system_clock</span><span class="special">::</span><span class="identifier">time_point</span><span class="special">;</span>
<span class="identifier">time_point</span> <span class="identifier">start</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">time_point</span><span class="special">,</span> <span class="identifier">ip_address</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">log</span> <span class="special">=</span> <span class="special">{</span>
    <span class="special">{</span> <span class="identifier">start</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">seconds</span><span class="special">(</span><span class="number">10</span><span class="special">),</span> <span class="special">{</span><span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">11</span><span class="special">}</span> <span class="special">},</span>
    <span class="special">{</span> <span class="identifier">start</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">hours</span><span class="special">(</span><span class="number">2</span><span class="special">),</span>    <span class="special">{</span><span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">13</span><span class="special">}</span> <span class="special">},</span>
    <span class="special">{</span> <span class="identifier">start</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">minutes</span><span class="special">(</span><span class="number">14</span><span class="special">),</span> <span class="special">{</span><span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">10</span><span class="special">}</span> <span class="special">},</span>
<span class="special">};</span>
<span class="identifier">value</span> <span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span>
    <span class="identifier">log</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_tuple</span><span class="special">(</span> <span class="identifier">as_string</span><span class="special">(),</span> <span class="identifier">as_iso_8601</span><span class="special">()</span> <span class="special">)</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span>
    <span class="string">" [                                                   "</span>
    <span class="string">"     [ \"1970-01-01T00:00:10\", \"192.168.10.11\" ], "</span>
    <span class="string">"     [ \"1970-01-01T02:00:10\", \"192.168.10.13\" ], "</span>
    <span class="string">"     [ \"1970-01-01T02:14:10\", \"192.168.10.10\" ]  "</span>
    <span class="string">" ]                                                   "</span>
    <span class="special">)</span> <span class="special">);</span>
</pre>
<p>
        In this snippet <code class="computeroutput"><span class="identifier">time_point</span></code>
        is converted using <code class="computeroutput"><span class="identifier">tag_invoke</span></code>
        overload that takes <code class="computeroutput"><span class="identifier">as_iso_8601</span></code>,
        <code class="computeroutput"><span class="identifier">ip_address</span></code> is converted using
        <code class="computeroutput"><span class="identifier">tag_invoke</span></code> overload that
        takes <code class="computeroutput"><span class="identifier">as_string</span></code>, and <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span></code>
        is converted using a generic conversion provided by the library.
      </p>
<h5>
<a name="json.conversion.contextual_conversions.h3"></a>
        <span class="phrase"><a name="json.conversion.contextual_conversions.contexts_and_composite_types"></a></span><a class="link" href="contextual_conversions.html#json.conversion.contextual_conversions.contexts_and_composite_types">Contexts
        and composite types</a>
      </h5>
<p>
        As was shown previously, generic conversions provided by the library forward
        contexts to conversions of nested objects. And in the case when you want
        to provide your own conversion function for a composite type enabled by a
        particular context, you usually also need to do that.
      </p>
<p>
        Consider this example. As was discussed in a previous section, <a class="link" href="../ref/boost__json__is_map_like.html" title="is_map_like"><code class="computeroutput"><span class="identifier">is_map_like</span></code></a> requires that your key
        type satisfies <a class="link" href="../ref/boost__json__is_string_like.html" title="is_string_like"><code class="computeroutput"><span class="identifier">is_string_like</span></code></a>. Now, let's say your
        keys are not string-like, but they do convert to <a class="link" href="../ref/boost__json__string.html" title="string"><code class="computeroutput"><span class="identifier">string</span></code></a>. You can make such maps to
        also convert to objects using a context. But if you want to also use another
        context for values, you need a way to pass the full combined context to map
        elements. So, you want the following test to succeed.
      </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="identifier">time_point</span><span class="special">,</span> <span class="identifier">ip_address</span> <span class="special">&gt;</span> <span class="identifier">log</span> <span class="special">=</span> <span class="special">{</span>
    <span class="special">{</span> <span class="identifier">start</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">seconds</span><span class="special">(</span><span class="number">10</span><span class="special">),</span> <span class="special">{</span><span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">11</span><span class="special">}</span> <span class="special">},</span>
    <span class="special">{</span> <span class="identifier">start</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">hours</span><span class="special">(</span><span class="number">2</span><span class="special">),</span>    <span class="special">{</span><span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">13</span><span class="special">}</span> <span class="special">},</span>
    <span class="special">{</span> <span class="identifier">start</span> <span class="special">+=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">minutes</span><span class="special">(</span><span class="number">14</span><span class="special">),</span> <span class="special">{</span><span class="number">192</span><span class="special">,</span> <span class="number">168</span><span class="special">,</span> <span class="number">10</span><span class="special">,</span> <span class="number">10</span><span class="special">}</span> <span class="special">},</span>
<span class="special">};</span>

<span class="identifier">value</span> <span class="identifier">jv</span> <span class="special">=</span> <span class="identifier">value_from</span><span class="special">(</span>
    <span class="identifier">log</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_tuple</span><span class="special">(</span> <span class="identifier">maps_as_objects</span><span class="special">(),</span> <span class="identifier">as_string</span><span class="special">(),</span> <span class="identifier">as_iso_8601</span><span class="special">()</span> <span class="special">)</span> <span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span> <span class="identifier">jv</span> <span class="special">==</span> <span class="identifier">parse</span><span class="special">(</span>
    <span class="string">" {                                               "</span>
    <span class="string">"     \"1970-01-01T00:00:10\": \"192.168.10.11\", "</span>
    <span class="string">"     \"1970-01-01T02:00:10\": \"192.168.10.13\", "</span>
    <span class="string">"     \"1970-01-01T02:14:10\": \"192.168.10.10\"  "</span>
    <span class="string">" }                                               "</span>
    <span class="special">)</span> <span class="special">);</span>
</pre>
<p>
        For this you will have to use a different overload of <code class="computeroutput"><span class="identifier">tag_invoke</span></code>.
        This time it has to be a function template, and it should have two parameters
        for contexts. The first parameter is the specific context that disambiguates
        that particular overload. The second parameter is the full context passed
        to <a class="link" href="../ref/boost__json__value_to.html" title="value_to"><code class="computeroutput"><span class="identifier">value_to</span></code></a>
        or <a class="link" href="../ref/boost__json__value_from.html" title="value_from"><code class="computeroutput"><span class="identifier">value_from</span></code></a>.
      </p>
<pre class="programlisting"><span class="keyword">namespace</span> <span class="identifier">user_ns</span>
<span class="special">{</span>

<span class="keyword">struct</span> <span class="identifier">maps_as_objects</span>
<span class="special">{</span> <span class="special">};</span>

<span class="keyword">template</span><span class="special">&lt;</span>
    <span class="keyword">class</span> <span class="identifier">Key</span><span class="special">,</span>
    <span class="keyword">class</span> <span class="identifier">Value</span><span class="special">,</span>
    <span class="keyword">class</span> <span class="identifier">Ctx</span> <span class="special">&gt;</span>
<span class="keyword">void</span>
<span class="identifier">tag_invoke</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from_tag</span><span class="special">,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value</span><span class="special">&amp;</span> <span class="identifier">jv</span><span class="special">,</span>
    <span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span><span class="identifier">Key</span><span class="special">,</span> <span class="identifier">Value</span><span class="special">&gt;&amp;</span> <span class="identifier">m</span><span class="special">,</span>
    <span class="keyword">const</span> <span class="identifier">maps_as_objects</span><span class="special">&amp;,</span>
    <span class="keyword">const</span> <span class="identifier">Ctx</span><span class="special">&amp;</span> <span class="identifier">ctx</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">object</span><span class="special">&amp;</span> <span class="identifier">jo</span> <span class="special">=</span> <span class="identifier">jv</span><span class="special">.</span><span class="identifier">emplace_object</span><span class="special">();</span>

    <span class="keyword">for</span><span class="special">(</span> <span class="keyword">const</span> <span class="keyword">auto</span><span class="special">&amp;</span> <span class="identifier">item</span><span class="special">:</span> <span class="identifier">m</span> <span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">auto</span> <span class="identifier">k</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">item</span><span class="special">.</span><span class="identifier">first</span><span class="special">,</span> <span class="identifier">ctx</span><span class="special">,</span> <span class="identifier">jo</span><span class="special">.</span><span class="identifier">storage</span><span class="special">()</span> <span class="special">);</span>
        <span class="keyword">auto</span> <span class="identifier">v</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from</span><span class="special">(</span> <span class="identifier">item</span><span class="special">.</span><span class="identifier">second</span><span class="special">,</span> <span class="identifier">ctx</span><span class="special">,</span> <span class="identifier">jo</span><span class="special">.</span><span class="identifier">storage</span><span class="special">()</span> <span class="special">);</span>
        <span class="identifier">jo</span><span class="special">[</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span> <span class="identifier">k</span><span class="special">.</span><span class="identifier">as_string</span><span class="special">()</span> <span class="special">)]</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span> <span class="identifier">v</span> <span class="special">);</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="keyword">template</span><span class="special">&lt;</span>
    <span class="keyword">class</span> <span class="identifier">Key</span><span class="special">,</span>
    <span class="keyword">class</span> <span class="identifier">Value</span><span class="special">,</span>
    <span class="keyword">class</span> <span class="identifier">Ctx</span> <span class="special">&gt;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span><span class="identifier">Key</span><span class="special">,</span> <span class="identifier">Value</span><span class="special">&gt;</span>
<span class="identifier">tag_invoke</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_to_tag</span><span class="special">&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span><span class="identifier">Key</span><span class="special">,</span> <span class="identifier">Value</span><span class="special">&gt;</span> <span class="special">&gt;,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value</span> <span class="keyword">const</span><span class="special">&amp;</span> <span class="identifier">jv</span><span class="special">,</span>
    <span class="keyword">const</span> <span class="identifier">maps_as_objects</span><span class="special">&amp;,</span>
    <span class="keyword">const</span> <span class="identifier">Ctx</span><span class="special">&amp;</span> <span class="identifier">ctx</span> <span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">object</span><span class="special">&amp;</span> <span class="identifier">jo</span> <span class="special">=</span> <span class="identifier">jv</span><span class="special">.</span><span class="identifier">as_object</span><span class="special">();</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="identifier">Key</span><span class="special">,</span> <span class="identifier">Value</span> <span class="special">&gt;</span> <span class="identifier">result</span><span class="special">;</span>
    <span class="keyword">for</span><span class="special">(</span> <span class="keyword">auto</span><span class="special">&amp;&amp;</span> <span class="identifier">item</span><span class="special">:</span> <span class="identifier">jo</span> <span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">Key</span> <span class="identifier">k</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_to</span><span class="special">&lt;</span> <span class="identifier">Key</span> <span class="special">&gt;(</span> <span class="identifier">item</span><span class="special">.</span><span class="identifier">key</span><span class="special">(),</span> <span class="identifier">ctx</span> <span class="special">);</span>
        <span class="identifier">Value</span> <span class="identifier">v</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_to</span><span class="special">&lt;</span> <span class="identifier">Value</span> <span class="special">&gt;(</span> <span class="identifier">item</span><span class="special">.</span><span class="identifier">value</span><span class="special">(),</span> <span class="identifier">ctx</span> <span class="special">);</span>
        <span class="identifier">result</span><span class="special">.</span><span class="identifier">emplace</span><span class="special">(</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">k</span><span class="special">),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">v</span><span class="special">)</span> <span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="identifier">result</span><span class="special">;</span>
<span class="special">}</span>

<span class="special">}</span>
</pre>
</div>
<div class="copyright-footer">Copyright © 2019, 2020 Vinnie Falco<br>Copyright © 2020 Krystian Stasiowski<br>Copyright © 2022 Dmitry Arkhipov<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="allocation_control.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../conversion.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="avoiding_physical_dependency.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
