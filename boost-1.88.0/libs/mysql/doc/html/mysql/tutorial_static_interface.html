<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Tutorial 4: the static interface</title>
<link rel="stylesheet" href="../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../index.html" title="Chapter 1. Boost.MySQL">
<link rel="up" href="../index.html" title="Chapter 1. Boost.MySQL">
<link rel="prev" href="tutorial_with_params.html" title="Tutorial 3: queries with parameters">
<link rel="next" href="tutorial_updates_transactions.html" title="Tutorial 5: UPDATEs, transactions and semicolon-separated queries">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../boost.png"></td>
<td align="center"><a href="../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="tutorial_with_params.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="tutorial_updates_transactions.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="mysql.tutorial_static_interface"></a><a class="link" href="tutorial_static_interface.html" title="Tutorial 4: the static interface">Tutorial 4: the static
    interface</a>
</h2></div></div></div>
<p>
      Until now we've read the rows generated by our queries into <a class="link" href="ref/boost__mysql__results.html" title="results"><code class="literal">results</code></a>
      objects. As we've seen, <code class="computeroutput"><span class="identifier">results</span></code>
      is a 2D structure that contains variant-like values. Throughout the documentation,
      these variant-based APIs are called <a class="link" href="dynamic_interface.html" title="The dynamic interface">the
      dynamic interface</a>.
    </p>
<h4>
<a name="mysql.tutorial_static_interface.h0"></a>
      <span class="phrase"><a name="mysql.tutorial_static_interface.dynamic_interface_limitations"></a></span><a class="link" href="tutorial_static_interface.html#mysql.tutorial_static_interface.dynamic_interface_limitations">Dynamic
      interface limitations</a>
    </h4>
<p>
      Working with variant-like objects can be cumbersome. Recall the following lines
      from our previous tutorial, where we used the retrieved rows:
    </p>
<pre class="programlisting"><span class="comment">// Did we find an employee with that ID?</span>
<span class="keyword">if</span> <span class="special">(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">empty</span><span class="special">())</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Employee not found"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>
<span class="keyword">else</span>
<span class="special">{</span>
    <span class="comment">// Print the retrieved details. The first field is the first name,</span>
    <span class="comment">// and the second, the last name.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">row_view</span> <span class="identifier">employee</span> <span class="special">=</span> <span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">at</span><span class="special">(</span><span class="number">0</span><span class="special">);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Employee's name is: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">employee</span><span class="special">.</span><span class="identifier">at</span><span class="special">(</span><span class="number">0</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="char">' '</span> <span class="special">&lt;&lt;</span> <span class="identifier">employee</span><span class="special">.</span><span class="identifier">at</span><span class="special">(</span><span class="number">1</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
      An employee is represented here by a <a class="link" href="ref/boost__mysql__row_view.html" title="row_view"><code class="literal">row_view</code></a>,
      which is a collection of <a class="link" href="ref/boost__mysql__field_view.html" title="field_view"><code class="literal">field_view</code></a>
      objects. <code class="computeroutput"><span class="identifier">field_view</span></code> is a variant-like
      type that can represent all the types supported by MySQL.
    </p>
<p>
      Since <code class="computeroutput"><span class="identifier">field_view</span></code> supports streaming,
      this code doesn't require any casting. However, consider refactoring our code
      to split the printing logic to a separate function:
    </p>
<pre class="programlisting"><span class="keyword">void</span> <span class="identifier">print_employee</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">first_name</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">last_name</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Employee's name is: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">first_name</span> <span class="special">&lt;&lt;</span> <span class="char">' '</span> <span class="special">&lt;&lt;</span> <span class="identifier">last_name</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
      Looking at our database schema, we know that both values are strings. We can
      use <a class="link" href="ref/boost__mysql__field_view/as_string.html" title="field_view::as_string"><code class="literal">field_view::as_string</code></a>
      to perform the casts:
    </p>
<pre class="programlisting"><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">row_view</span> <span class="identifier">employee</span> <span class="special">=</span> <span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">at</span><span class="special">(</span><span class="number">0</span><span class="special">);</span>
<span class="identifier">print_employee</span><span class="special">(</span><span class="identifier">employee</span><span class="special">.</span><span class="identifier">at</span><span class="special">(</span><span class="number">0</span><span class="special">).</span><span class="identifier">as_string</span><span class="special">(),</span> <span class="identifier">employee</span><span class="special">.</span><span class="identifier">at</span><span class="special">(</span><span class="number">1</span><span class="special">).</span><span class="identifier">as_string</span><span class="special">());</span>
</pre>
<p>
      While this code works, it can create maintenance problems:
    </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
          We retrieve fields by position. That is, we know that <code class="computeroutput"><span class="identifier">employee</span><span class="special">.</span><span class="identifier">at</span><span class="special">(</span><span class="number">0</span><span class="special">)</span></code> holds
          the employee's <code class="computeroutput"><span class="identifier">first_name</span></code>.
          However, if we refactor our query, we might forget updating the indices.
        </li>
<li class="listitem">
          Following a similar reasoning, the casts are error-prone.
        </li>
<li class="listitem">
          Both <code class="computeroutput"><span class="identifier">at</span></code> and <code class="computeroutput"><span class="identifier">as_string</span></code> throw on error. Attempting
          to avoid exceptions while still performing the required safety checks quickly
          becomes unmanageable.
        </li>
</ul></div>
<p>
      If we know the types returned by our queries at compile time, we can use the
      static interface, instead. This interface can parse the rows returned by a
      query into instances of a C++ struct defined by us.
    </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../../../../doc/src/images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
        The static interface requires C++14 or later.
      </p></td></tr>
</table></div>
<h4>
<a name="mysql.tutorial_static_interface.h1"></a>
      <span class="phrase"><a name="mysql.tutorial_static_interface.using_static_results_with_boost_"></a></span><a class="link" href="tutorial_static_interface.html#mysql.tutorial_static_interface.using_static_results_with_boost_">Using
      static_results with Boost.Pfr</a>
    </h4>
<p>
      In C++20 and later, we can use <a href="../../../../../libs/pfr/index.html" target="_top">Boost.Pfr</a>
      and the <a class="link" href="ref/boost__mysql__static_results.html" title="static_results"><code class="literal">static_results</code></a>
      class to parse the rows. The first step is to define a plain C++ struct with
      the fields we expect in our query:
    </p>
<pre class="programlisting"><span class="comment">// Should contain a member for each field of interest present in our query.</span>
<span class="comment">// Declaration order doesn't need to match field order in the query.</span>
<span class="comment">// Field names should match the ones in our query</span>
<span class="keyword">struct</span> <span class="identifier">employee</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">first_name</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">last_name</span><span class="special">;</span>
<span class="special">};</span>
</pre>
<p>
      We now replace the <a class="link" href="ref/boost__mysql__results.html" title="results"><code class="literal">results</code></a>
      object by a <a class="link" href="ref/boost__mysql__static_results.html" title="static_results"><code class="literal">static_results</code></a>.
      The marker type <a class="link" href="ref/boost__mysql__pfr_by_name.html" title="pfr_by_name"><code class="literal">pfr_by_name</code></a>
      indicates Boot.MySQL that it should use Boost.Pfr for reflection.
    </p>
<pre class="programlisting"><span class="comment">// Using static_results will parse the result of our query</span>
<span class="comment">// into instances of the employee type. Fields will be matched</span>
<span class="comment">// by name, instead of by position.</span>
<span class="comment">// pfr_by_name tells the library to use Boost.Pfr for reflection,</span>
<span class="comment">// and to match fields by name.</span>
<span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pfr_by_name</span><span class="special">&lt;</span><span class="identifier">employee</span><span class="special">&gt;&gt;</span> <span class="identifier">result</span><span class="special">;</span>

<span class="comment">// Execute the query with the given parameters, performing the required</span>
<span class="comment">// escaping to prevent SQL injection.</span>
<span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">.</span><span class="identifier">async_execute</span><span class="special">(</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span><span class="string">"SELECT first_name, last_name FROM employee WHERE id = {}"</span><span class="special">,</span> <span class="identifier">employee_id</span><span class="special">),</span>
    <span class="identifier">result</span>
<span class="special">);</span>
</pre>
<p>
      Using the retrieved data is now much easier, since <a class="link" href="ref/boost__mysql__static_results/rows.html" title="static_results::rows"><code class="literal">static_results::rows</code></a>
      returns a <code class="computeroutput"><span class="identifier">span</span><span class="special">&lt;</span><span class="keyword">const</span> <span class="identifier">employee</span><span class="special">&gt;</span></code>:
    </p>
<pre class="programlisting"><span class="comment">// Did we find an employee with that ID?</span>
<span class="keyword">if</span> <span class="special">(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">empty</span><span class="special">())</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Employee not found"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>
<span class="keyword">else</span>
<span class="special">{</span>
    <span class="comment">// Print the retrieved details</span>
    <span class="keyword">const</span> <span class="identifier">employee</span><span class="special">&amp;</span> <span class="identifier">emp</span> <span class="special">=</span> <span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">()[</span><span class="number">0</span><span class="special">];</span>
    <span class="identifier">print_employee</span><span class="special">(</span><span class="identifier">emp</span><span class="special">.</span><span class="identifier">first_name</span><span class="special">,</span> <span class="identifier">emp</span><span class="special">.</span><span class="identifier">last_name</span><span class="special">);</span>
<span class="special">}</span>
</pre>
<p>
      When using the static interface, <code class="computeroutput"><span class="identifier">async_execute</span></code>
      will perform a set of checks on the query results to ensure compatibility between
      the C++ types and what MySQL returns. These checks aim to discover potential
      problems as early as possible, and are called <a class="link" href="static_interface.html#mysql.static_interface.meta_checks">metadata
      checks</a>.
    </p>
<h4>
<a name="mysql.tutorial_static_interface.h2"></a>
      <span class="phrase"><a name="mysql.tutorial_static_interface.using_the_static_interface_in_c_"></a></span><a class="link" href="tutorial_static_interface.html#mysql.tutorial_static_interface.using_the_static_interface_in_c_">Using
      the static interface in C++14</a>
    </h4>
<p>
      C++20 makes it possible to use Boost.Pfr as described here, which is the easiest
      option. Boost.MySQL also supports <a href="../../../../../libs/describe/index.html" target="_top">Boost.Describe</a>
      and <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span></code>'s, which can be used in C++14. The
      mechanics are quite similar to what's been explained here.
    </p>
<h4>
<a name="mysql.tutorial_static_interface.h3"></a>
      <span class="phrase"><a name="mysql.tutorial_static_interface.wrapping_up"></a></span><a class="link" href="tutorial_static_interface.html#mysql.tutorial_static_interface.wrapping_up">Wrapping
      up</a>
    </h4>
<p>
      <a class="link" href="static_interface.html" title="The static interface">This section</a> contains more information
      about the static interface.
    </p>
<p>
      Full program listing for this tutorial is <a class="link" href="examples/tutorial_static_interface.html" title="Tutorial 4 listing: the static interface">here</a>.
    </p>
<p>
      You can now proceed to <a class="link" href="tutorial_updates_transactions.html" title="Tutorial 5: UPDATEs, transactions and semicolon-separated queries">the
      next tutorial</a>.
    </p>
</div>
<div class="copyright-footer">Copyright © 2019-2024 Ruben Perez<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="tutorial_with_params.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="tutorial_updates_transactions.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
