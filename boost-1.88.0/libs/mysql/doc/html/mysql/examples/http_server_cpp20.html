<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>A REST API server that uses C++20 coroutines</title>
<link rel="stylesheet" href="../../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../../index.html" title="Chapter 1. Boost.MySQL">
<link rel="up" href="../examples.html" title="Examples">
<link rel="prev" href="pipeline.html" title="(Experimental) Pipelines">
<link rel="next" href="http_server_cpp14_coroutines.html" title="A C++14 REST API server that uses asio::yield_context">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="pipeline.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="http_server_cpp14_coroutines.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.examples.http_server_cpp20"></a><a class="link" href="http_server_cpp20.html" title="A REST API server that uses C++20 coroutines">A REST API server that
      uses C++20 coroutines</a>
</h3></div></div></div>
<p>
        This example assumes you have gone through the <a class="link" href="../examples.html#mysql.examples.setup">setup</a>.
      </p>
<pre class="programlisting"><span class="comment">/**
 * Implements a HTTP REST API using Boost.MySQL and Boost.Beast.
 * The API models a simplified order management system for an online store.
 * Using the API, users can query the store's product catalog, create and
 * edit orders, and check them out for payment.
 *
 * The API defines the following endpoints:
 *
 *    GET    /products?search={s}       Returns a list of products
 *    GET    /orders                    Returns all orders
 *    GET    /orders?id={}              Returns a single order
 *    POST   /orders                    Creates a new order
 *    POST   /orders/items              Adds a new order item to an existing order
 *    DELETE /orders/items?id={}        Deletes an order item
 *    POST   /orders/checkout?id={}     Checks out an order
 *    POST   /orders/complete?id={}     Completes an order
 *
 * Each order can have any number of order items. An order item
 * represents an individual product that has been added to an order.
 * Orders are created empty, in a 'draft' state. Items can then be
 * added and removed from the order. After adding the desired items,
 * orders can be checked out for payment. A third-party service, like Stripe,
 * would be used to collect the payment. For simplicity, we've left this part
 * out of the example. Once checked out, an order is no longer editable.
 * Finally, after successful payment, order are transitioned to the
 * 'complete' status.
 *
 * The server uses C++20 coroutines and is multi-threaded.
 * It also requires linking to Boost::json and Boost::url.
 * The database schema is defined in db_setup.sql, in the same directory as this file.
 * You need to source this file before running the example.
 */</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">any_address</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">pool_params</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">co_spawn</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">detached</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">signal_set</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">thread_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstddef</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdlib</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">exception</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"server.hpp"</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">orders</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">mysql</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">asio</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">;</span>

<span class="comment">// The number of threads to use</span>
<span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">num_threads</span> <span class="special">=</span> <span class="number">5</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main_impl</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">argv</span><span class="special">[])</span>
<span class="special">{</span>
    <span class="comment">// Check command line arguments.</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">argc</span> <span class="special">!=</span> <span class="number">5</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"Usage: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">0</span><span class="special">]</span> <span class="special">&lt;&lt;</span> <span class="string">" &lt;username&gt; &lt;password&gt; &lt;mysql-hostname&gt; &lt;port&gt;\n"</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="identifier">EXIT_FAILURE</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Application config</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">mysql_username</span> <span class="special">=</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">];</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">mysql_password</span> <span class="special">=</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">2</span><span class="special">];</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">mysql_hostname</span> <span class="special">=</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">3</span><span class="special">];</span>
    <span class="keyword">auto</span> <span class="identifier">port</span> <span class="special">=</span> <span class="keyword">static_cast</span><span class="special">&lt;</span><span class="keyword">unsigned</span> <span class="keyword">short</span><span class="special">&gt;(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">stoi</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">4</span><span class="special">]));</span>

    <span class="comment">// An event loop, where the application will run.</span>
    <span class="comment">// We will use the main thread to run the pool, too, so we use</span>
    <span class="comment">// one thread less than configured</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">thread_pool</span> <span class="identifier">th_pool</span><span class="special">(</span><span class="identifier">num_threads</span> <span class="special">-</span> <span class="number">1</span><span class="special">);</span>

    <span class="comment">// Create a connection pool</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span> <span class="identifier">pool</span><span class="special">(</span>
        <span class="comment">// Use the thread pool as execution context</span>
        <span class="identifier">th_pool</span><span class="special">,</span>

        <span class="comment">// Pool configuration</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pool_params</span><span class="special">{</span>
            <span class="comment">// Connect using TCP, to the given hostname and using the default port</span>
            <span class="special">.</span><span class="identifier">server_address</span> <span class="special">=</span> <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">host_and_port</span><span class="special">{</span><span class="identifier">mysql_hostname</span><span class="special">},</span>

            <span class="comment">// Authenticate using the given username</span>
            <span class="special">.</span><span class="identifier">username</span> <span class="special">=</span> <span class="identifier">mysql_username</span><span class="special">,</span>

            <span class="comment">// Password for the above username</span>
            <span class="special">.</span><span class="identifier">password</span> <span class="special">=</span> <span class="identifier">mysql_password</span><span class="special">,</span>

            <span class="comment">// Database to use when connecting</span>
            <span class="special">.</span><span class="identifier">database</span> <span class="special">=</span> <span class="string">"boost_mysql_orders"</span><span class="special">,</span>

            <span class="comment">// We're using multi-queries</span>
            <span class="special">.</span><span class="identifier">multi_queries</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">,</span>

            <span class="comment">// Using thread_safe will make the pool thread-safe by internally</span>
            <span class="comment">// creating and using a strand.</span>
            <span class="comment">// This allows us to share the pool between sessions, which may run</span>
            <span class="comment">// concurrently, on different threads.</span>
            <span class="special">.</span><span class="identifier">thread_safe</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">,</span>
        <span class="special">}</span>
    <span class="special">);</span>

    <span class="comment">// Launch the MySQL pool</span>
    <span class="identifier">pool</span><span class="special">.</span><span class="identifier">async_run</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">detached</span><span class="special">);</span>

    <span class="comment">// A signal_set allows us to intercept SIGINT and SIGTERM and</span>
    <span class="comment">// exit gracefully</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">signal_set</span> <span class="identifier">signals</span><span class="special">{</span><span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">get_executor</span><span class="special">(),</span> <span class="identifier">SIGINT</span><span class="special">,</span> <span class="identifier">SIGTERM</span><span class="special">};</span>

    <span class="comment">// Capture SIGINT and SIGTERM to perform a clean shutdown</span>
    <span class="identifier">signals</span><span class="special">.</span><span class="identifier">async_wait</span><span class="special">([&amp;</span><span class="identifier">th_pool</span><span class="special">](</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span><span class="special">,</span> <span class="keyword">int</span><span class="special">)</span> <span class="special">{</span>
        <span class="comment">// Stop the execution context. This will cause main to exit</span>
        <span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">stop</span><span class="special">();</span>
    <span class="special">});</span>

    <span class="comment">// Start listening for HTTP connections. This will run until the context is stopped</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">co_spawn</span><span class="special">(</span>
        <span class="comment">// Use the thread pool to run the listener coroutine</span>
        <span class="identifier">th_pool</span><span class="special">,</span>

        <span class="comment">// The coroutine to run</span>
        <span class="special">[&amp;</span><span class="identifier">pool</span><span class="special">,</span> <span class="identifier">port</span><span class="special">]</span> <span class="special">{</span> <span class="keyword">return</span> <span class="identifier">run_server</span><span class="special">(</span><span class="identifier">pool</span><span class="special">,</span> <span class="identifier">port</span><span class="special">);</span> <span class="special">},</span>

        <span class="comment">// If an exception is thrown in the listener coroutine, propagate it</span>
        <span class="special">[](</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">exception_ptr</span> <span class="identifier">exc</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">exc</span><span class="special">)</span>
                <span class="identifier">std</span><span class="special">::</span><span class="identifier">rethrow_exception</span><span class="special">(</span><span class="identifier">exc</span><span class="special">);</span>
        <span class="special">}</span>
    <span class="special">);</span>

    <span class="comment">// Attach the current thread to the thread pool. This will block</span>
    <span class="comment">// until stop() is called</span>
    <span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">attach</span><span class="special">();</span>

    <span class="comment">// Wait until all threads have exited</span>
    <span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">join</span><span class="special">();</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Server exiting"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

    <span class="comment">// (If we get here, it means we got a SIGINT or SIGTERM)</span>
    <span class="keyword">return</span> <span class="identifier">EXIT_SUCCESS</span><span class="special">;</span>
<span class="special">}</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">char</span><span class="special">**</span> <span class="identifier">argv</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">try</span>
    <span class="special">{</span>
        <span class="identifier">main_impl</span><span class="special">(</span><span class="identifier">argc</span><span class="special">,</span> <span class="identifier">argv</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span><span class="special">&amp;</span> <span class="identifier">err</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"Error: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">err</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: types.hpp</span>
<span class="comment">//</span>
<span class="comment">// Contains type definitions used in the REST API and database code.</span>
<span class="comment">// We use Boost.Describe (BOOST_DESCRIBE_STRUCT) to add reflection</span>
<span class="comment">// capabilities to our types. This allows using Boost.MySQL</span>
<span class="comment">// static interface (i.e. static_results&lt;T&gt;) to parse query results,</span>
<span class="comment">// and Boost.JSON automatic serialization/deserialization.</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">describe</span><span class="special">/</span><span class="keyword">class</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">optional</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string_view</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">vector</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">orders</span> <span class="special">{</span>

<span class="comment">// A product object, as defined in the database and in the GET /products endpoint</span>
<span class="keyword">struct</span> <span class="identifier">product</span>
<span class="special">{</span>
    <span class="comment">// The unique database ID of the object.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">;</span>

    <span class="comment">// The product's display name</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">short_name</span><span class="special">;</span>

    <span class="comment">// The product's description</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;</span> <span class="identifier">descr</span><span class="special">;</span>

    <span class="comment">// The product's price, in dollar cents</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">price</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">product</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">id</span><span class="special">,</span> <span class="identifier">short_name</span><span class="special">,</span> <span class="identifier">descr</span><span class="special">,</span> <span class="identifier">price</span><span class="special">))</span>

<span class="comment">// An order object, as defined in the database and in some REST endpoints.</span>
<span class="comment">// This object does not include the items associated to the order.</span>
<span class="keyword">struct</span> <span class="identifier">order</span>
<span class="special">{</span>
    <span class="comment">// The unique database ID of the object.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">;</span>

    <span class="comment">// The order status. One of "draft", "pending_payment" or "complete".</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">status</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">order</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">id</span><span class="special">,</span> <span class="identifier">status</span><span class="special">))</span>

<span class="comment">// Constants for the order::status member</span>
<span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">status_draft</span> <span class="special">=</span> <span class="string">"draft"</span><span class="special">;</span>
<span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">status_pending_payment</span> <span class="special">=</span> <span class="string">"pending_payment"</span><span class="special">;</span>
<span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">status_complete</span> <span class="special">=</span> <span class="string">"complete"</span><span class="special">;</span>

<span class="comment">// An order item object, as defined in the database and in some REST endpoints.</span>
<span class="comment">// Does not include the order_id database field.</span>
<span class="keyword">struct</span> <span class="identifier">order_item</span>
<span class="special">{</span>
    <span class="comment">// The unique database ID of the object.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">;</span>

    <span class="comment">// The ID of the product that this order item represents</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">product_id</span><span class="special">;</span>

    <span class="comment">// The number of units of the product that this item represents.</span>
    <span class="comment">// For instance, if product_id=2 and quantity=3,</span>
    <span class="comment">// the user wants to buy 3 units of the product with ID 2.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">quantity</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">order_item</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">id</span><span class="special">,</span> <span class="identifier">product_id</span><span class="special">,</span> <span class="identifier">quantity</span><span class="special">))</span>

<span class="comment">// An order object, with its associated order items.</span>
<span class="comment">// Used in some REST endpoints.</span>
<span class="keyword">struct</span> <span class="identifier">order_with_items</span>
<span class="special">{</span>
    <span class="comment">// The unique database ID of the object.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">;</span>

    <span class="comment">// The order status. One of "draft", "pending_payment" or "complete".</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">status</span><span class="special">;</span>

    <span class="comment">// The items associated to this order.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">order_item</span><span class="special">&gt;</span> <span class="identifier">items</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">order_with_items</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">id</span><span class="special">,</span> <span class="identifier">status</span><span class="special">,</span> <span class="identifier">items</span><span class="special">))</span>

<span class="comment">// REST request for POST /orders/items</span>
<span class="keyword">struct</span> <span class="identifier">add_order_item_request</span>
<span class="special">{</span>
    <span class="comment">// Identifies the order to which the item should be added.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">order_id</span><span class="special">;</span>

    <span class="comment">// Identifies the product that should be added to the order.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">product_id</span><span class="special">;</span>

    <span class="comment">// The number of units of the above product that should be added to the order.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">quantity</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">add_order_item_request</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">order_id</span><span class="special">,</span> <span class="identifier">product_id</span><span class="special">,</span> <span class="identifier">quantity</span><span class="special">))</span>

<span class="special">}</span>  <span class="comment">// namespace orders</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: error.hpp</span>
<span class="comment">//</span>
<span class="comment">// Contains an errc enumeration and the required pieces to</span>
<span class="comment">// use it with boost::system::error_code.</span>
<span class="comment">// We use this indirectly in the DB repository class,</span>
<span class="comment">// when using the error codes in boost::system::result.</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_category</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">mutex</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string_view</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">type_traits</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">orders</span> <span class="special">{</span>

<span class="comment">// Error code enum for errors originated within our application</span>
<span class="keyword">enum</span> <span class="keyword">class</span> <span class="identifier">errc</span>
<span class="special">{</span>
    <span class="identifier">not_found</span><span class="special">,</span>             <span class="comment">// couldn't retrieve or modify a certain resource because it doesn't exist</span>
    <span class="identifier">order_invalid_status</span><span class="special">,</span>  <span class="comment">// an operation found an order in a status != the one expected (e.g. not editable)</span>
    <span class="identifier">product_not_found</span><span class="special">,</span>     <span class="comment">// a product referenced by a request doesn't exist</span>
<span class="special">};</span>

<span class="comment">// To use errc with boost::system::error_code, we need</span>
<span class="comment">// to define an error category (see the cpp file).</span>
<span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_category</span><span class="special">&amp;</span> <span class="identifier">get_orders_category</span><span class="special">();</span>

<span class="comment">// Called when constructing an error_code from an errc value.</span>
<span class="keyword">inline</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">make_error_code</span><span class="special">(</span><span class="identifier">errc</span> <span class="identifier">v</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Roughly, an error_code is an int and a category defining what the int means.</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span><span class="special">(</span><span class="keyword">static_cast</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;(</span><span class="identifier">v</span><span class="special">),</span> <span class="identifier">get_orders_category</span><span class="special">());</span>
<span class="special">}</span>

<span class="comment">// In multi-threaded programs, using std::cerr without any locking</span>
<span class="comment">// can result in interleaved output.</span>
<span class="comment">// Locks a mutex guarding std::cerr to prevent this.</span>
<span class="comment">// All uses of std::cerr should respect this.</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">unique_lock</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">mutex</span><span class="special">&gt;</span> <span class="identifier">lock_cerr</span><span class="special">();</span>

<span class="comment">// A helper function for the common case where we want to log an error code</span>
<span class="keyword">void</span> <span class="identifier">log_error</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">header</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">);</span>

<span class="special">}</span>  <span class="comment">// namespace orders</span>

<span class="comment">// This specialization is required to construct error_code's from errc values</span>
<span class="keyword">template</span> <span class="special">&lt;&gt;</span>
<span class="keyword">struct</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">is_error_code_enum</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">&gt;</span> <span class="special">:</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">true_type</span>
<span class="special">{</span>
<span class="special">};</span>
</pre>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_category</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">mutex</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"error.hpp"</span>

<span class="keyword">namespace</span> <span class="special">{</span>

<span class="comment">// Converts an orders::errc to string</span>
<span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">error_to_string</span><span class="special">(</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span> <span class="identifier">value</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">switch</span> <span class="special">(</span><span class="identifier">value</span><span class="special">)</span>
    <span class="special">{</span>
    <span class="keyword">case</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">:</span> <span class="keyword">return</span> <span class="string">"not_found"</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">order_invalid_status</span><span class="special">:</span> <span class="keyword">return</span> <span class="string">"order_invalid_status"</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">product_not_found</span><span class="special">:</span> <span class="keyword">return</span> <span class="string">"product_not_found"</span><span class="special">;</span>
    <span class="keyword">default</span><span class="special">:</span> <span class="keyword">return</span> <span class="string">"&lt;unknown orders::errc&gt;"</span><span class="special">;</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="comment">// The category to be returned by get_orders_category</span>
<span class="keyword">class</span> <span class="identifier">orders_category</span> <span class="identifier">final</span> <span class="special">:</span> <span class="keyword">public</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_category</span>
<span class="special">{</span>
<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">// Identifies the error category. Used when converting error_codes to string</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">name</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> <span class="identifier">final</span> <span class="identifier">override</span> <span class="special">{</span> <span class="keyword">return</span> <span class="string">"orders"</span><span class="special">;</span> <span class="special">}</span>

    <span class="comment">// Given a numeric error belonging to this category, convert it to a string</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">message</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">ev</span><span class="special">)</span> <span class="keyword">const</span> <span class="identifier">final</span> <span class="identifier">override</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">error_to_string</span><span class="special">(</span><span class="keyword">static_cast</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">&gt;(</span><span class="identifier">ev</span><span class="special">));</span>
    <span class="special">}</span>
<span class="special">};</span>

<span class="comment">// The error category</span>
<span class="keyword">static</span> <span class="keyword">const</span> <span class="identifier">orders_category</span> <span class="identifier">g_category</span><span class="special">;</span>

<span class="comment">// The std::mutex that guards std::cerr</span>
<span class="keyword">static</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">mutex</span> <span class="identifier">g_cerr_mutex</span><span class="special">;</span>

<span class="special">}</span>  <span class="comment">// namespace</span>

<span class="comment">//</span>
<span class="comment">// External interface</span>
<span class="comment">//</span>
<span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_category</span><span class="special">&amp;</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">get_orders_category</span><span class="special">()</span> <span class="special">{</span> <span class="keyword">return</span> <span class="identifier">g_category</span><span class="special">;</span> <span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">unique_lock</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">mutex</span><span class="special">&gt;</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">lock_cerr</span><span class="special">()</span> <span class="special">{</span> <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">unique_lock</span><span class="special">{</span><span class="identifier">g_cerr_mutex</span><span class="special">};</span> <span class="special">}</span>

<span class="keyword">void</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">log_error</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">header</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Lock the mutex</span>
    <span class="keyword">auto</span> <span class="identifier">guard</span> <span class="special">=</span> <span class="identifier">lock_cerr</span><span class="special">();</span>

    <span class="comment">// Logging the error code prints the number and category. Add the message, too</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="identifier">header</span> <span class="special">&lt;&lt;</span> <span class="string">": "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span> <span class="special">&lt;&lt;</span> <span class="string">" "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: repository.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string_view</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">vector</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">orders</span> <span class="special">{</span>

<span class="comment">// Encapsulates database logic.</span>
<span class="comment">// If the database is unavailable, these functions throw.</span>
<span class="comment">// Additionally, functions that may fail depending on the supplied input</span>
<span class="comment">// return boost::system::result&lt;T&gt;, avoiding exceptions in common cases.</span>
<span class="keyword">class</span> <span class="identifier">db_repository</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool_</span><span class="special">;</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">// Constructor (this is a cheap-to-construct object)</span>
    <span class="identifier">db_repository</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">)</span> <span class="keyword">noexcept</span> <span class="special">:</span> <span class="identifier">pool_</span><span class="special">(</span><span class="identifier">pool</span><span class="special">)</span> <span class="special">{}</span>

    <span class="comment">// Retrieves products using a full-text search</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">product</span><span class="special">&gt;&gt;</span> <span class="identifier">get_products</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">search</span><span class="special">);</span>

    <span class="comment">// Retrieves all the orders in the database</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">order</span><span class="special">&gt;&gt;</span> <span class="identifier">get_orders</span><span class="special">();</span>

    <span class="comment">// Retrieves an order by ID.</span>
    <span class="comment">// Returns an error if the ID doesn't match any order.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">get_order_by_id</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">);</span>

    <span class="comment">// Creates an empty order. Returns the created order.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">create_order</span><span class="special">();</span>

    <span class="comment">// Adds an item to an order. Retrieves the updated order.</span>
    <span class="comment">// Returns an error if the ID doesn't match any order, the order</span>
    <span class="comment">// is not editable, or the product_id doesn't match any product</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">add_order_item</span><span class="special">(</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">order_id</span><span class="special">,</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">product_id</span><span class="special">,</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">quantity</span>
    <span class="special">);</span>

    <span class="comment">// Removes an item from an order. Retrieves the updated order.</span>
    <span class="comment">// Returns an error if the ID doesn't match any order item</span>
    <span class="comment">// or the order is not editable.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">remove_order_item</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">item_id</span><span class="special">);</span>

    <span class="comment">// Checks an order out, transitioning it to the pending_payment status.</span>
    <span class="comment">// Returns an error if the ID doesn't match any order</span>
    <span class="comment">// or the order is not editable.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">checkout_order</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">);</span>

    <span class="comment">// Completes an order, transitioning it to the complete status.</span>
    <span class="comment">// Returns an error if the ID doesn't match any order</span>
    <span class="comment">// or the order is not checked out.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">complete_order</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">);</span>
<span class="special">};</span>

<span class="special">}</span>  <span class="comment">// namespace orders</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: repository.cpp</span>
<span class="comment">//</span>
<span class="comment">// See the db_setup.sql file in this folder for the table definitions</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">static_results</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">with_params</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string_view</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">tuple</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">vector</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"error.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"repository.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">mysql</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">asio</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">;</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">orders</span><span class="special">;</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">product</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">get_products</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">search</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Get the products using the MySQL built-in full-text search feature.</span>
    <span class="comment">// Look for the query string in the short_name and descr fields.</span>
    <span class="comment">// Parse the query results into product struct instances</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">product</span><span class="special">&gt;</span> <span class="identifier">res</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"SELECT id, short_name, descr, price FROM products "</span>
            <span class="string">"WHERE MATCH(short_name, descr) AGAINST({}) "</span>
            <span class="string">"LIMIT 10"</span><span class="special">,</span>
            <span class="identifier">search</span>
        <span class="special">),</span>
        <span class="identifier">res</span>
    <span class="special">);</span>

    <span class="comment">// By default, connections are reset after they are returned to the pool</span>
    <span class="comment">// (by using any_connection::async_reset_connection). This will reset any</span>
    <span class="comment">// session state we changed while we were using the connection</span>
    <span class="comment">// (e.g. it will deallocate any statements we prepared).</span>
    <span class="comment">// We did nothing to mutate session state, so we can tell the pool to skip</span>
    <span class="comment">// this step, providing a minor performance gain.</span>
    <span class="comment">// We use pooled_connection::return_without_reset to do this.</span>
    <span class="comment">// If an exception was raised, the connection would be reset, for safety.</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// Return the result</span>
    <span class="identifier">co_return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">product</span><span class="special">&gt;{</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">res</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">end</span><span class="special">()};</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">order</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">get_orders</span><span class="special">()</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Get all the orders.</span>
    <span class="comment">// Parse the result into order structs.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">order</span><span class="special">&gt;</span> <span class="identifier">res</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span><span class="string">"SELECT id, status FROM orders"</span><span class="special">,</span> <span class="identifier">res</span><span class="special">);</span>

    <span class="comment">// We didn't mutate session state, so we can skip resetting the connection</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// Return the result</span>
    <span class="identifier">co_return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">order</span><span class="special">&gt;{</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">res</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">end</span><span class="special">()};</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">get_order_by_id</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Get a single order and all its associated items.</span>
    <span class="comment">// The transaction ensures atomicity between the two SELECTs.</span>
    <span class="comment">// We issued 4 queries, so we get 4 resultsets back.</span>
    <span class="comment">// Ignore the 1st and 4th, and parse the other two into order and order_item structs</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order</span><span class="special">,</span> <span class="identifier">order_item</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">result</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"START TRANSACTION READ ONLY;"</span>
            <span class="string">"SELECT id, status FROM orders WHERE id = {0};"</span>
            <span class="string">"SELECT id, product_id, quantity FROM order_items WHERE order_id = {0};"</span>
            <span class="string">"COMMIT"</span><span class="special">,</span>
            <span class="identifier">id</span>
        <span class="special">),</span>
        <span class="identifier">result</span>
    <span class="special">);</span>

    <span class="comment">// We didn't mutate session state</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// result.rows&lt;N&gt; returns the rows for the N-th resultset, as a span</span>
    <span class="keyword">auto</span> <span class="identifier">orders</span> <span class="special">=</span> <span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;();</span>
    <span class="keyword">auto</span> <span class="identifier">order_items</span> <span class="special">=</span> <span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">2</span><span class="special">&gt;();</span>

    <span class="comment">// Did we find the order we're looking for?</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">orders</span><span class="special">.</span><span class="identifier">empty</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="identifier">order</span><span class="special">&amp;</span> <span class="identifier">ord</span> <span class="special">=</span> <span class="identifier">orders</span><span class="special">[</span><span class="number">0</span><span class="special">];</span>

    <span class="comment">// If we did, compose the result</span>
    <span class="identifier">co_return</span> <span class="identifier">order_with_items</span><span class="special">{</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">id</span><span class="special">,</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">status</span><span class="special">,</span>
        <span class="special">{</span><span class="identifier">order_items</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">order_items</span><span class="special">.</span><span class="identifier">end</span><span class="special">()}</span>
    <span class="special">};</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">create_order</span><span class="special">()</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Create the new order.</span>
    <span class="comment">// Orders are created empty, with all fields defaulted.</span>
    <span class="comment">// MySQL does not have an INSERT ... RETURNING statement, so we use</span>
    <span class="comment">// a transaction with an INSERT and a SELECT to create the order</span>
    <span class="comment">// and retrieve it atomically.</span>
    <span class="comment">// This yields 4 resultsets, one per SQL statement.</span>
    <span class="comment">// Ignore all except the SELECT, and parse it into an order struct.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">result</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="string">"START TRANSACTION;"</span>
        <span class="string">"INSERT INTO orders () VALUES ();"</span>
        <span class="string">"SELECT id, status FROM orders WHERE id = LAST_INSERT_ID();"</span>
        <span class="string">"COMMIT"</span><span class="special">,</span>
        <span class="identifier">result</span>
    <span class="special">);</span>

    <span class="comment">// We didn't mutate session state</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// This must always yield one row. Return it.</span>
    <span class="keyword">const</span> <span class="identifier">order</span><span class="special">&amp;</span> <span class="identifier">ord</span> <span class="special">=</span> <span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">2</span><span class="special">&gt;().</span><span class="identifier">front</span><span class="special">();</span>
    <span class="identifier">co_return</span> <span class="identifier">order_with_items</span><span class="special">{</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">id</span><span class="special">,</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">status</span><span class="special">,</span>
        <span class="special">{}</span>  <span class="comment">// A newly created order never has items</span>
    <span class="special">};</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">add_order_item</span><span class="special">(</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">order_id</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">product_id</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">quantity</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Retrieve the order and the product.</span>
    <span class="comment">// SELECT ... FOR UPDATE places a lock on the retrieved rows,</span>
    <span class="comment">// so they're not modified by other transactions while we use them.</span>
    <span class="comment">// If you're targeting MySQL 8.0+, you can also use SELECT ... FOR SHARE.</span>
    <span class="comment">// For the product, we only need to check that it does exist,</span>
    <span class="comment">// so we get its ID and parse the returned rows into a std::tuple.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span><span class="special">&gt;&gt;</span> <span class="identifier">result1</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"START TRANSACTION;"</span>
            <span class="string">"SELECT id, status FROM orders WHERE id = {} FOR UPDATE;"</span>
            <span class="string">"SELECT id FROM products WHERE id = {} FOR UPDATE"</span><span class="special">,</span>
            <span class="identifier">order_id</span><span class="special">,</span>
            <span class="identifier">product_id</span>
        <span class="special">),</span>
        <span class="identifier">result1</span>
    <span class="special">);</span>

    <span class="comment">// Check that the order exists</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="comment">// Not found. We did mutate session state by opening a transaction,</span>
        <span class="comment">// so we can't use return_without_reset</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">const</span> <span class="identifier">order</span><span class="special">&amp;</span> <span class="identifier">ord</span> <span class="special">=</span> <span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">front</span><span class="special">();</span>

    <span class="comment">// Verify that the order is editable.</span>
    <span class="comment">// Using SELECT ... FOR UPDATE prevents race conditions with this check.</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ord</span><span class="special">.</span><span class="identifier">status</span> <span class="special">!=</span> <span class="identifier">status_draft</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">order_invalid_status</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Check that the product exists</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">2</span><span class="special">&gt;().</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">product_not_found</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Insert the new item and retrieve all the items associated to this order</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order_item</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">result2</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"INSERT INTO order_items (order_id, product_id, quantity) VALUES ({0}, {1}, {2});"</span>
            <span class="string">"SELECT id, product_id, quantity FROM order_items WHERE order_id = {0};"</span>
            <span class="string">"COMMIT"</span><span class="special">,</span>
            <span class="identifier">order_id</span><span class="special">,</span>
            <span class="identifier">product_id</span><span class="special">,</span>
            <span class="identifier">quantity</span>
        <span class="special">),</span>
        <span class="identifier">result2</span>
    <span class="special">);</span>

    <span class="comment">// If everything went well, we didn't mutate session state</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// Compose the return value</span>
    <span class="identifier">co_return</span> <span class="identifier">order_with_items</span><span class="special">{</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">id</span><span class="special">,</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">status</span><span class="special">,</span>
        <span class="special">{</span><span class="identifier">result2</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">result2</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">end</span><span class="special">()}</span>
    <span class="special">};</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">remove_order_item</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">item_id</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Retrieve the order.</span>
    <span class="comment">// SELECT ... FOR UPDATE places a lock on the order and the item,</span>
    <span class="comment">// so they're not modified by other transactions while we use them.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order</span><span class="special">&gt;</span> <span class="identifier">result1</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"START TRANSACTION;"</span>
            <span class="string">"SELECT ord.id AS id, status FROM orders ord"</span>
            <span class="string">"  JOIN order_items it ON (ord.id = it.order_id)"</span>
            <span class="string">"  WHERE it.id = {} FOR UPDATE"</span><span class="special">,</span>
            <span class="identifier">item_id</span>
        <span class="special">),</span>
        <span class="identifier">result1</span>
    <span class="special">);</span>

    <span class="comment">// Check that the item exists</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="comment">// Not found. We did mutate session state by opening a transaction,</span>
        <span class="comment">// so we can't use return_without_reset</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">const</span> <span class="identifier">order</span><span class="special">&amp;</span> <span class="identifier">ord</span> <span class="special">=</span> <span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">front</span><span class="special">();</span>

    <span class="comment">// Check that the order is editable</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ord</span><span class="special">.</span><span class="identifier">status</span> <span class="special">!=</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">status_draft</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">order_invalid_status</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Perform the deletion and retrieve the items</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order_item</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">result2</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"DELETE FROM order_items WHERE id = {};"</span>
            <span class="string">"SELECT id, product_id, quantity FROM order_items WHERE order_id = {};"</span>
            <span class="string">"COMMIT"</span><span class="special">,</span>
            <span class="identifier">item_id</span><span class="special">,</span>
            <span class="identifier">ord</span><span class="special">.</span><span class="identifier">id</span>
        <span class="special">),</span>
        <span class="identifier">result2</span>
    <span class="special">);</span>

    <span class="comment">// If everything went well, we didn't mutate session state</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// Compose the return value</span>
    <span class="identifier">co_return</span> <span class="identifier">order_with_items</span><span class="special">{</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">id</span><span class="special">,</span>
        <span class="identifier">ord</span><span class="special">.</span><span class="identifier">status</span><span class="special">,</span>
        <span class="special">{</span><span class="identifier">result2</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">result2</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">end</span><span class="special">()}</span>
    <span class="special">};</span>
<span class="special">}</span>

<span class="comment">// Helper function to implement checkout_order and complete_order</span>
<span class="keyword">static</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">change_order_status</span><span class="special">(</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">order_id</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">original_status</span><span class="special">,</span>  <span class="comment">// The status that the order should have</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">target_status</span>     <span class="comment">// The status to transition the order to</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Get a connection from the pool</span>
    <span class="keyword">auto</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">pool</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">();</span>

    <span class="comment">// Retrieve the order and lock it.</span>
    <span class="comment">// FOR UPDATE places an exclusive lock on the order,</span>
    <span class="comment">// preventing other concurrent transactions (including the ones</span>
    <span class="comment">// related to adding/removing items) from changing the order</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;&gt;</span> <span class="identifier">result1</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"START TRANSACTION;"</span>
            <span class="string">"SELECT status FROM orders WHERE id = {} FOR UPDATE;"</span><span class="special">,</span>
            <span class="identifier">order_id</span>
        <span class="special">),</span>
        <span class="identifier">result1</span>
    <span class="special">);</span>

    <span class="comment">// Check that the order exists</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Check that the order is in the expected status</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">get</span><span class="special">&lt;</span><span class="number">0</span><span class="special">&gt;(</span><span class="identifier">result1</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">front</span><span class="special">())</span> <span class="special">!=</span> <span class="identifier">original_status</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">co_return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">order_invalid_status</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Update the order and retrieve the order details</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;,</span> <span class="identifier">order_item</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">result2</span><span class="special">;</span>
    <span class="identifier">co_await</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span>
        <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">with_params</span><span class="special">(</span>
            <span class="string">"UPDATE orders SET status = {1} WHERE id = {0};"</span>
            <span class="string">"SELECT id, product_id, quantity FROM order_items WHERE order_id = {0};"</span>
            <span class="string">"COMMIT"</span><span class="special">,</span>
            <span class="identifier">order_id</span><span class="special">,</span>
            <span class="identifier">target_status</span>
        <span class="special">),</span>
        <span class="identifier">result2</span>
    <span class="special">);</span>

    <span class="comment">// If everything went well, we didn't mutate session state</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// Compose the return value</span>
    <span class="identifier">co_return</span> <span class="identifier">order_with_items</span><span class="special">{</span>
        <span class="identifier">order_id</span><span class="special">,</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="identifier">target_status</span><span class="special">),</span>
        <span class="special">{</span><span class="identifier">result2</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">result2</span><span class="special">.</span><span class="identifier">rows</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;().</span><span class="identifier">end</span><span class="special">()}</span>
    <span class="special">};</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">checkout_order</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">change_order_status</span><span class="special">(</span><span class="identifier">pool_</span><span class="special">,</span> <span class="identifier">id</span><span class="special">,</span> <span class="identifier">status_draft</span><span class="special">,</span> <span class="identifier">status_pending_payment</span><span class="special">);</span>
<span class="special">}</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">order_with_items</span><span class="special">&gt;&gt;</span> <span class="identifier">db_repository</span><span class="special">::</span><span class="identifier">complete_order</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">change_order_status</span><span class="special">(</span><span class="identifier">pool_</span><span class="special">,</span> <span class="identifier">id</span><span class="special">,</span> <span class="identifier">status_pending_payment</span><span class="special">,</span> <span class="identifier">status_complete</span><span class="special">);</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: handle_request.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">message</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">string_body</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">orders</span> <span class="special">{</span>

<span class="comment">// Handles an individual HTTP request, producing a response.</span>
<span class="comment">// The caller of this function should use response::version,</span>
<span class="comment">// response::keep_alive and response::prepare_payload to adjust the response.</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_request</span><span class="special">(</span>
    <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">request</span><span class="special">,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span>
<span class="special">);</span>

<span class="special">}</span>  <span class="comment">// namespace orders</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: handle_request.cpp</span>
<span class="comment">//</span>
<span class="comment">// This file contains all the boilerplate code to dispatch HTTP</span>
<span class="comment">// requests to API endpoints. Functions here end up calling</span>
<span class="comment">// db_repository fuctions.</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">diagnostics</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">error_with_diagnostics</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">message</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">status</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">string_body</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">verb</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">serialize</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">value_from</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">value_to</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">url_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">algorithm</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">charconv</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">exception</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">optional</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string_view</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">system_error</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">unordered_map</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">vector</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"error.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"handle_request.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"repository.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">asio</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">http</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">mysql</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">;</span>
<span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">;</span>

<span class="keyword">namespace</span> <span class="special">{</span>

<span class="comment">// Helper function that logs errors thrown by db_repository</span>
<span class="comment">// when an unexpected database error happens</span>
<span class="keyword">void</span> <span class="identifier">log_mysql_error</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">diagnostics</span><span class="special">&amp;</span> <span class="identifier">diag</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Lock std::cerr, to avoid race conditions</span>
    <span class="keyword">auto</span> <span class="identifier">guard</span> <span class="special">=</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">lock_cerr</span><span class="special">();</span>

    <span class="comment">// Inserting the error code only prints the number and category. Add the message, too.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"MySQL error: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span> <span class="special">&lt;&lt;</span> <span class="string">" "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">();</span>

    <span class="comment">// client_message() contains client-side generated messages that don't</span>
    <span class="comment">// contain user-input. This is usually embedded in exceptions.</span>
    <span class="comment">// When working with error codes, we need to log it explicitly</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">diag</span><span class="special">.</span><span class="identifier">client_message</span><span class="special">().</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">": "</span> <span class="special">&lt;&lt;</span> <span class="identifier">diag</span><span class="special">.</span><span class="identifier">client_message</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="comment">// server_message() contains server-side messages, and thus may</span>
    <span class="comment">// contain user-supplied input. Printing it is safe.</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">diag</span><span class="special">.</span><span class="identifier">server_message</span><span class="special">().</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">": "</span> <span class="special">&lt;&lt;</span> <span class="identifier">diag</span><span class="special">.</span><span class="identifier">server_message</span><span class="special">();</span>
    <span class="special">}</span>

    <span class="comment">// Done</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>

<span class="comment">// Attempts to parse a numeric ID from a string</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span><span class="special">&gt;</span> <span class="identifier">parse_id</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">from</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">{};</span>
    <span class="keyword">auto</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">from_chars</span><span class="special">(</span><span class="identifier">from</span><span class="special">.</span><span class="identifier">data</span><span class="special">(),</span> <span class="identifier">from</span><span class="special">.</span><span class="identifier">data</span><span class="special">()</span> <span class="special">+</span> <span class="identifier">from</span><span class="special">.</span><span class="identifier">size</span><span class="special">(),</span> <span class="identifier">id</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">ec</span> <span class="special">!=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">errc</span><span class="special">{}</span> <span class="special">||</span> <span class="identifier">res</span><span class="special">.</span><span class="identifier">ptr</span> <span class="special">!=</span> <span class="identifier">from</span><span class="special">.</span><span class="identifier">data</span><span class="special">()</span> <span class="special">+</span> <span class="identifier">from</span><span class="special">.</span><span class="identifier">size</span><span class="special">())</span>
        <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">nullopt</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="identifier">id</span><span class="special">;</span>
<span class="special">}</span>

<span class="comment">// Helpers to create error responses with a single line of code</span>
<span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span> <span class="identifier">code</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">msg</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">res</span><span class="special">;</span>
    <span class="identifier">res</span><span class="special">.</span><span class="identifier">result</span><span class="special">(</span><span class="identifier">code</span><span class="special">);</span>
    <span class="identifier">res</span><span class="special">.</span><span class="identifier">body</span><span class="special">()</span> <span class="special">=</span> <span class="identifier">msg</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="identifier">res</span><span class="special">;</span>
<span class="special">}</span>

<span class="comment">// Like error_response, but always uses a 400 status code</span>
<span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">body</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">bad_request</span><span class="special">,</span> <span class="identifier">body</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// Like error_response, but always uses a 500 status code and</span>
<span class="comment">// never provides extra information that might help potential attackers.</span>
<span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">internal_server_error</span><span class="special">()</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">internal_server_error</span><span class="special">,</span> <span class="string">"Internal server error"</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// Creates a response with a serialized JSON body.</span>
<span class="comment">// T should be a type with Boost.Describe metadata containing the</span>
<span class="comment">// body data to be serialized</span>
<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">T</span><span class="special">&gt;</span>
<span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">json_response</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">T</span><span class="special">&amp;</span> <span class="identifier">body</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">res</span><span class="special">;</span>

    <span class="comment">// Set the content-type header</span>
    <span class="identifier">res</span><span class="special">.</span><span class="identifier">set</span><span class="special">(</span><span class="string">"Content-Type"</span><span class="special">,</span> <span class="string">"application/json"</span><span class="special">);</span>

    <span class="comment">// Serialize the body data into a string and use it as the response body.</span>
    <span class="comment">// We use Boost.JSON's automatic serialization feature, which uses Boost.Describe</span>
    <span class="comment">// reflection data to generate a serialization function for us.</span>
    <span class="identifier">res</span><span class="special">.</span><span class="identifier">body</span><span class="special">()</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">serialize</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from</span><span class="special">(</span><span class="identifier">body</span><span class="special">));</span>

    <span class="comment">// Done</span>
    <span class="keyword">return</span> <span class="identifier">res</span><span class="special">;</span>
<span class="special">}</span>

<span class="comment">// Attempts to parse a string as a JSON into an object of type T.</span>
<span class="comment">// T should be a type with Boost.Describe metadata.</span>
<span class="comment">// We use boost::system::result, which may contain a result or an error.</span>
<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">T</span><span class="special">&gt;</span>
<span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;</span> <span class="identifier">parse_json</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">json_string</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Attempt to parse the request into a json::value.</span>
    <span class="comment">// This will fail if the provided body isn't valid JSON.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>
    <span class="keyword">auto</span> <span class="identifier">val</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">json_string</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Attempt to parse the json::value into a T. This will</span>
    <span class="comment">// fail if the provided JSON doesn't match T's shape.</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">try_value_to</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;(</span><span class="identifier">val</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// Generates an HTTP error response based on an error code</span>
<span class="comment">// returned by db_repository.</span>
<span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">response_from_db_error</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">.</span><span class="identifier">category</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">get_orders_category</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="keyword">switch</span> <span class="special">(</span><span class="keyword">static_cast</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">&gt;(</span><span class="identifier">ec</span><span class="special">.</span><span class="identifier">value</span><span class="special">()))</span>
        <span class="special">{</span>
        <span class="keyword">case</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">:</span>
            <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">,</span> <span class="string">"The referenced entity does not exist"</span><span class="special">);</span>
        <span class="keyword">case</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">product_not_found</span><span class="special">:</span>
            <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span>
                <span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">unprocessable_entity</span><span class="special">,</span>
                <span class="string">"The referenced product does not exist"</span>
            <span class="special">);</span>
        <span class="keyword">case</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">errc</span><span class="special">::</span><span class="identifier">order_invalid_status</span><span class="special">:</span>
            <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span>
                <span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">unprocessable_entity</span><span class="special">,</span>
                <span class="string">"The referenced order doesn't have the status required by the operation"</span>
            <span class="special">);</span>
        <span class="keyword">default</span><span class="special">:</span> <span class="keyword">return</span> <span class="identifier">internal_server_error</span><span class="special">();</span>
        <span class="special">}</span>
    <span class="special">}</span>
    <span class="keyword">else</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">internal_server_error</span><span class="special">();</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="comment">// Contains data associated to an HTTP request.</span>
<span class="comment">// To be passed to individual handler functions</span>
<span class="keyword">struct</span> <span class="identifier">request_data</span>
<span class="special">{</span>
    <span class="comment">// The incoming request</span>
    <span class="keyword">const</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">request</span><span class="special">;</span>

    <span class="comment">// The URL the request is targeting</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span> <span class="identifier">target</span><span class="special">;</span>

    <span class="comment">// Connection pool</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">;</span>

    <span class="identifier">orders</span><span class="special">::</span><span class="identifier">db_repository</span> <span class="identifier">repo</span><span class="special">()</span> <span class="keyword">const</span> <span class="special">{</span> <span class="keyword">return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">db_repository</span><span class="special">(</span><span class="identifier">pool</span><span class="special">);</span> <span class="special">}</span>
<span class="special">};</span>

<span class="comment">//</span>
<span class="comment">// Endpoint handlers. They should be functions with signature</span>
<span class="comment">// asio::awaitable&lt;http::response&lt;http::string_body&gt;&gt;(const request_data&amp;).</span>
<span class="comment">// Handlers are associated to a single URL path and HTTP method</span>
<span class="comment">//</span>

<span class="comment">// GET /products?search={s}: returns a list of products.</span>
<span class="comment">// The 'search' parameter is mandatory.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_get_products</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Parse the query parameter</span>
    <span class="keyword">auto</span> <span class="identifier">params_it</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">find</span><span class="special">(</span><span class="string">"search"</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">params_it</span> <span class="special">==</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">end</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Missing mandatory query parameter: 'search'"</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">search</span> <span class="special">=</span> <span class="special">(*</span><span class="identifier">params_it</span><span class="special">).</span><span class="identifier">value</span><span class="special">;</span>

    <span class="comment">// Invoke the database logic</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">product</span><span class="special">&gt;</span> <span class="identifier">products</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">get_products</span><span class="special">(</span><span class="identifier">search</span><span class="special">);</span>

    <span class="comment">// Return the response</span>
    <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">products</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// GET /orders: returns all orders</span>
<span class="comment">// GET /orders?id={}: returns a single order</span>
<span class="comment">// Both endpoints share handler because they share path and method</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_get_orders</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Parse the query parameter</span>
    <span class="keyword">auto</span> <span class="identifier">params_it</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">find</span><span class="special">(</span><span class="string">"id"</span><span class="special">);</span>

    <span class="comment">// Which of the two endpoints are we serving?</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">params_it</span> <span class="special">==</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">end</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="comment">// GET /orders</span>
        <span class="comment">// Invoke the database logic</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">order</span><span class="special">&gt;</span> <span class="identifier">orders</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">get_orders</span><span class="special">();</span>

        <span class="comment">// Return the response</span>
        <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">orders</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">else</span>
    <span class="special">{</span>
        <span class="comment">// GET /orders?id={}</span>
        <span class="comment">// Parse the query parameter</span>
        <span class="keyword">auto</span> <span class="identifier">order_id</span> <span class="special">=</span> <span class="identifier">parse_id</span><span class="special">((*</span><span class="identifier">params_it</span><span class="special">).</span><span class="identifier">value</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">order_id</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
            <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"URL parameter 'id' should be a valid integer"</span><span class="special">);</span>

        <span class="comment">// Invoke the database logic</span>
        <span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">order</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">get_order_by_id</span><span class="special">(*</span><span class="identifier">order_id</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">order</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
            <span class="identifier">co_return</span> <span class="identifier">response_from_db_error</span><span class="special">(</span><span class="identifier">order</span><span class="special">.</span><span class="identifier">error</span><span class="special">());</span>

        <span class="comment">// Return the response</span>
        <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(*</span><span class="identifier">order</span><span class="special">);</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="comment">// POST /orders: creates a new order.</span>
<span class="comment">// Orders are created empty, so this request has no body.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_create_order</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Invoke the database logic</span>
    <span class="identifier">orders</span><span class="special">::</span><span class="identifier">order_with_items</span> <span class="identifier">order</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">create_order</span><span class="special">();</span>

    <span class="comment">// Return the response</span>
    <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">order</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// POST /orders/items: adds a new order item to an existing order.</span>
<span class="comment">// The request has a JSON body, described by the add_order_item_request struct.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_add_order_item</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Check that the request has the appropriate content type</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">request</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="string">"Content-Type"</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">==</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">request</span><span class="special">.</span><span class="identifier">end</span><span class="special">()</span> <span class="special">||</span> <span class="identifier">it</span><span class="special">-&gt;</span><span class="identifier">value</span><span class="special">()</span> <span class="special">!=</span> <span class="string">"application/json"</span><span class="special">)</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Invalid Content-Type: expected 'application/json'"</span><span class="special">);</span>

    <span class="comment">// Parse the request body</span>
    <span class="keyword">auto</span> <span class="identifier">req</span> <span class="special">=</span> <span class="identifier">parse_json</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">add_order_item_request</span><span class="special">&gt;(</span><span class="identifier">input</span><span class="special">.</span><span class="identifier">request</span><span class="special">.</span><span class="identifier">body</span><span class="special">());</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">req</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Invalid JSON body"</span><span class="special">);</span>

    <span class="comment">// Invoke the database logic</span>
    <span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">()</span>
                                               <span class="special">.</span><span class="identifier">add_order_item</span><span class="special">(</span><span class="identifier">req</span><span class="special">-&gt;</span><span class="identifier">order_id</span><span class="special">,</span> <span class="identifier">req</span><span class="special">-&gt;</span><span class="identifier">product_id</span><span class="special">,</span> <span class="identifier">req</span><span class="special">-&gt;</span><span class="identifier">quantity</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">response_from_db_error</span><span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">error</span><span class="special">());</span>

    <span class="comment">// Return the response</span>
    <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(*</span><span class="identifier">res</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// DELETE /orders/items?id={}: deletes an order item.</span>
<span class="comment">// The request has no body.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_remove_order_item</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Parse the query parameter</span>
    <span class="keyword">auto</span> <span class="identifier">params_it</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">find</span><span class="special">(</span><span class="string">"id"</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">params_it</span> <span class="special">==</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">end</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Mandatory URL parameter 'id' not found"</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">id</span> <span class="special">=</span> <span class="identifier">parse_id</span><span class="special">((*</span><span class="identifier">params_it</span><span class="special">).</span><span class="identifier">value</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">id</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"URL parameter 'id' should be a valid integer"</span><span class="special">);</span>

    <span class="comment">// Invoke the database logic</span>
    <span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">remove_order_item</span><span class="special">(*</span><span class="identifier">id</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">response_from_db_error</span><span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">error</span><span class="special">());</span>

    <span class="comment">// Return the response</span>
    <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(*</span><span class="identifier">res</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// POST /orders/checkout?id={}: checks out an order.</span>
<span class="comment">// The request has no body.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_checkout_order</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Parse the query parameter</span>
    <span class="keyword">auto</span> <span class="identifier">params_it</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">find</span><span class="special">(</span><span class="string">"id"</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">params_it</span> <span class="special">==</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">end</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Mandatory URL parameter 'id' not found"</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">id</span> <span class="special">=</span> <span class="identifier">parse_id</span><span class="special">((*</span><span class="identifier">params_it</span><span class="special">).</span><span class="identifier">value</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">id</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"URL parameter 'id' should be a valid integer"</span><span class="special">);</span>

    <span class="comment">// Invoke the database logic</span>
    <span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">checkout_order</span><span class="special">(*</span><span class="identifier">id</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">response_from_db_error</span><span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">error</span><span class="special">());</span>

    <span class="comment">// Return the response</span>
    <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(*</span><span class="identifier">res</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// POST /orders/complete?id={}: marks an order as completed.</span>
<span class="comment">// The request has no body.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">handle_complete_order</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;</span> <span class="identifier">input</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Parse the query parameter</span>
    <span class="keyword">auto</span> <span class="identifier">params_it</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">find</span><span class="special">(</span><span class="string">"id"</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">params_it</span> <span class="special">==</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">params</span><span class="special">().</span><span class="identifier">end</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Mandatory URL parameter 'id' not found"</span><span class="special">);</span>
    <span class="keyword">auto</span> <span class="identifier">id</span> <span class="special">=</span> <span class="identifier">parse_id</span><span class="special">((*</span><span class="identifier">params_it</span><span class="special">).</span><span class="identifier">value</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">id</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"URL parameter 'id' should be a valid integer"</span><span class="special">);</span>

    <span class="comment">// Invoke the database logic</span>
    <span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">orders</span><span class="special">::</span><span class="identifier">order_with_items</span><span class="special">&gt;</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">input</span><span class="special">.</span><span class="identifier">repo</span><span class="special">().</span><span class="identifier">complete_order</span><span class="special">(*</span><span class="identifier">id</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">response_from_db_error</span><span class="special">(</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">error</span><span class="special">());</span>

    <span class="comment">// Return the response</span>
    <span class="identifier">co_return</span> <span class="identifier">json_response</span><span class="special">(*</span><span class="identifier">res</span><span class="special">);</span>
<span class="special">}</span>

<span class="comment">// handle_request uses a table to dispatch to each endpoint.</span>
<span class="comment">// This is the table's element type.</span>
<span class="keyword">struct</span> <span class="identifier">http_endpoint</span>
<span class="special">{</span>
    <span class="comment">// The HTTP method associated to this endpoint.</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span> <span class="identifier">method</span><span class="special">;</span>

    <span class="comment">// The endpoint handler.</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="special">(*</span><span class="identifier">handler</span><span class="special">)(</span><span class="keyword">const</span> <span class="identifier">request_data</span><span class="special">&amp;);</span>
<span class="special">};</span>

<span class="comment">// Maps from a URL path to an endpoint handler.</span>
<span class="comment">// A URL path might be present more than once, for different methods.</span>
<span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">unordered_multimap</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">,</span> <span class="identifier">http_endpoint</span><span class="special">&gt;</span> <span class="identifier">endpoint_table</span><span class="special">{</span>
    <span class="special">{</span><span class="string">"/products"</span><span class="special">,</span>        <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">get</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_get_products</span><span class="special">}</span>         <span class="special">},</span>
    <span class="special">{</span><span class="string">"/orders"</span><span class="special">,</span>          <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">get</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_get_orders</span><span class="special">}</span>           <span class="special">},</span>
    <span class="special">{</span><span class="string">"/orders"</span><span class="special">,</span>          <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">post</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_create_order</span><span class="special">}</span>        <span class="special">},</span>
    <span class="special">{</span><span class="string">"/orders/items"</span><span class="special">,</span>    <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">post</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_add_order_item</span><span class="special">}</span>      <span class="special">},</span>
    <span class="special">{</span><span class="string">"/orders/items"</span><span class="special">,</span>    <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">delete_</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_remove_order_item</span><span class="special">}},</span>
    <span class="special">{</span><span class="string">"/orders/checkout"</span><span class="special">,</span> <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">post</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_checkout_order</span><span class="special">}</span>      <span class="special">},</span>
    <span class="special">{</span><span class="string">"/orders/complete"</span><span class="special">,</span> <span class="special">{</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">post</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">handle_complete_order</span><span class="special">}</span>      <span class="special">},</span>
<span class="special">};</span>

<span class="special">}</span>  <span class="comment">// namespace</span>

<span class="comment">// External interface</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&gt;</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">handle_request</span><span class="special">(</span>
    <span class="keyword">const</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">request</span><span class="special">,</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// Parse the request target</span>
    <span class="keyword">auto</span> <span class="identifier">target</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_origin_form</span><span class="special">(</span><span class="identifier">request</span><span class="special">.</span><span class="identifier">target</span><span class="special">());</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">target</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">bad_request</span><span class="special">(</span><span class="string">"Invalid request target"</span><span class="special">);</span>

    <span class="comment">// Try to find an endpoint</span>
    <span class="keyword">auto</span> <span class="special">[</span><span class="identifier">it1</span><span class="special">,</span> <span class="identifier">it2</span><span class="special">]</span> <span class="special">=</span> <span class="identifier">endpoint_table</span><span class="special">.</span><span class="identifier">equal_range</span><span class="special">(</span><span class="identifier">target</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">());</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">it1</span> <span class="special">==</span> <span class="identifier">endpoint_table</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
        <span class="identifier">co_return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">,</span> <span class="string">"The requested endpoint does not exist"</span><span class="special">);</span>

    <span class="comment">// Match the verb. The table structure that we created</span>
    <span class="comment">// allows us to distinguish between an "endpoint does not exist" error</span>
    <span class="comment">// and an "unsupported method" error.</span>
    <span class="keyword">auto</span> <span class="identifier">it3</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">find_if</span><span class="special">(</span><span class="identifier">it1</span><span class="special">,</span> <span class="identifier">it2</span><span class="special">,</span> <span class="special">[&amp;</span><span class="identifier">request</span><span class="special">](</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">,</span> <span class="identifier">http_endpoint</span><span class="special">&gt;&amp;</span> <span class="identifier">ep</span><span class="special">)</span> <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">ep</span><span class="special">.</span><span class="identifier">second</span><span class="special">.</span><span class="identifier">method</span> <span class="special">==</span> <span class="identifier">request</span><span class="special">.</span><span class="identifier">method</span><span class="special">();</span>
    <span class="special">});</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">it3</span> <span class="special">==</span> <span class="identifier">it2</span><span class="special">)</span>
        <span class="identifier">co_return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">method_not_allowed</span><span class="special">,</span> <span class="string">"Unsupported HTTP method"</span><span class="special">);</span>

    <span class="comment">// Invoke the handler</span>
    <span class="keyword">try</span>
    <span class="special">{</span>
        <span class="comment">// Attempt to handle the request</span>
        <span class="identifier">co_return</span> <span class="identifier">co_await</span> <span class="identifier">it3</span><span class="special">-&gt;</span><span class="identifier">second</span><span class="special">.</span><span class="identifier">handler</span><span class="special">(</span><span class="identifier">request_data</span><span class="special">{</span><span class="identifier">request</span><span class="special">,</span> <span class="special">*</span><span class="identifier">target</span><span class="special">,</span> <span class="identifier">pool</span><span class="special">});</span>
    <span class="special">}</span>
    <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_with_diagnostics</span><span class="special">&amp;</span> <span class="identifier">err</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// A Boost.MySQL error. This will happen if you don't have connectivity</span>
        <span class="comment">// to your database, your schema is incorrect or your credentials are invalid.</span>
        <span class="comment">// Log the error, including diagnostics</span>
        <span class="identifier">log_mysql_error</span><span class="special">(</span><span class="identifier">err</span><span class="special">.</span><span class="identifier">code</span><span class="special">(),</span> <span class="identifier">err</span><span class="special">.</span><span class="identifier">get_diagnostics</span><span class="special">());</span>

        <span class="comment">// Never disclose error info to a potential attacker</span>
        <span class="identifier">co_return</span> <span class="identifier">internal_server_error</span><span class="special">();</span>
    <span class="special">}</span>
    <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span><span class="special">&amp;</span> <span class="identifier">err</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// Another kind of error. This indicates a programming error or a severe</span>
        <span class="comment">// server condition (e.g. out of memory). Same procedure as above.</span>
        <span class="special">{</span>
            <span class="keyword">auto</span> <span class="identifier">guard</span> <span class="special">=</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">lock_cerr</span><span class="special">();</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"Uncaught exception: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">err</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="special">}</span>
        <span class="identifier">co_return</span> <span class="identifier">internal_server_error</span><span class="special">();</span>
    <span class="special">}</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: server.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">orders</span> <span class="special">{</span>

<span class="comment">// Launches a HTTP server that will listen on 0.0.0.0:port.</span>
<span class="comment">// If the server fails to launch (e.g. because the port is already in use),</span>
<span class="comment">// throws an exception. The server runs until the underlying execution</span>
<span class="comment">// context is stopped.</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span> <span class="identifier">run_server</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">,</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="identifier">port</span><span class="special">);</span>

<span class="special">}</span>  <span class="comment">// namespace orders</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: server.cpp</span>
<span class="comment">//</span>
<span class="comment">// This file contains all the boilerplate code to implement a HTTP</span>
<span class="comment">// server. Functions here end up invoking handle_request.</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">as_tuple</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">awaitable</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">cancel_after</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">co_spawn</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">ip</span><span class="special">/</span><span class="identifier">address</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">ip</span><span class="special">/</span><span class="identifier">tcp</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">redirect_error</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">steady_timer</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">strand</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">this_coro</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">core</span><span class="special">/</span><span class="identifier">flat_buffer</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">error</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">message</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">parser</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">read</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">string_body</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">verb</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">write</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdlib</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">exception</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string_view</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"error.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"handle_request.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"server.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">asio</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">http</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">mysql</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">;</span>

<span class="keyword">namespace</span> <span class="special">{</span>

<span class="comment">// Runs a single HTTP session until the client closes the connection.</span>
<span class="comment">// This coroutine will be spawned on a strand, to prevent data races.</span>
<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span> <span class="identifier">run_http_session</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span> <span class="identifier">sock</span><span class="special">,</span> <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono_literals</span><span class="special">;</span>

    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// A buffer to read incoming client requests</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">flat_buffer</span> <span class="identifier">buff</span><span class="special">;</span>

    <span class="comment">// A timer, to use with asio::cancel_after to implement timeouts.</span>
    <span class="comment">// Re-using the same timer multiple times with cancel_after</span>
    <span class="comment">// is more efficient than using raw cancel_after,</span>
    <span class="comment">// since the timer doesn't need to be re-created for every operation.</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">steady_timer</span> <span class="identifier">timer</span><span class="special">(</span><span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">this_coro</span><span class="special">::</span><span class="identifier">executor</span><span class="special">);</span>

    <span class="comment">// A HTTP session might involve more than one message if</span>
    <span class="comment">// keep-alive semantics are used. Loop until the connection closes.</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="keyword">true</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// Construct a new parser for each message</span>
        <span class="identifier">http</span><span class="special">::</span><span class="identifier">request_parser</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">parser</span><span class="special">;</span>

        <span class="comment">// Apply a reasonable limit to the allowed size</span>
        <span class="comment">// of the body in bytes to prevent abuse.</span>
        <span class="identifier">parser</span><span class="special">.</span><span class="identifier">body_limit</span><span class="special">(</span><span class="number">10000</span><span class="special">);</span>

        <span class="comment">// Read a request. redirect_error prevents exceptions from being thrown</span>
        <span class="comment">// on error. We use cancel_after to set a timeout for the overall read operation.</span>
        <span class="identifier">co_await</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">async_read</span><span class="special">(</span>
            <span class="identifier">sock</span><span class="special">,</span>
            <span class="identifier">buff</span><span class="special">,</span>
            <span class="identifier">parser</span><span class="special">.</span><span class="identifier">get</span><span class="special">(),</span>
            <span class="identifier">asio</span><span class="special">::</span><span class="identifier">cancel_after</span><span class="special">(</span><span class="identifier">timer</span><span class="special">,</span> <span class="number">60</span><span class="identifier">s</span><span class="special">,</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">redirect_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">))</span>
        <span class="special">);</span>

        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">error</span><span class="special">::</span><span class="identifier">end_of_stream</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// This means they closed the connection</span>
                <span class="identifier">sock</span><span class="special">.</span><span class="identifier">shutdown</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span><span class="special">::</span><span class="identifier">shutdown_send</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="special">}</span>
            <span class="keyword">else</span>
            <span class="special">{</span>
                <span class="comment">// An unknown error happened</span>
                <span class="identifier">orders</span><span class="special">::</span><span class="identifier">log_error</span><span class="special">(</span><span class="string">"Error reading HTTP request: "</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="special">}</span>
            <span class="identifier">co_return</span><span class="special">;</span>
        <span class="special">}</span>

        <span class="keyword">const</span> <span class="keyword">auto</span><span class="special">&amp;</span> <span class="identifier">request</span> <span class="special">=</span> <span class="identifier">parser</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>

        <span class="comment">// Process the request to generate a response.</span>
        <span class="comment">// This invokes the business logic, which will need to access MySQL data.</span>
        <span class="comment">// Apply a timeout to the overall request handling process.</span>
        <span class="keyword">auto</span> <span class="identifier">response</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">co_spawn</span><span class="special">(</span>
            <span class="comment">// Use the same executor as this coroutine (it will be a strand)</span>
            <span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">this_coro</span><span class="special">::</span><span class="identifier">executor</span><span class="special">,</span>

            <span class="comment">// The logic to invoke</span>
            <span class="special">[&amp;]</span> <span class="special">{</span> <span class="keyword">return</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">handle_request</span><span class="special">(</span><span class="identifier">request</span><span class="special">,</span> <span class="identifier">pool</span><span class="special">);</span> <span class="special">},</span>

            <span class="comment">// Completion token. Returns an object that can be co_await'ed</span>
            <span class="identifier">asio</span><span class="special">::</span><span class="identifier">cancel_after</span><span class="special">(</span><span class="identifier">timer</span><span class="special">,</span> <span class="number">30</span><span class="identifier">s</span><span class="special">)</span>
        <span class="special">);</span>

        <span class="comment">// Adjust the response, setting fields common to all responses</span>
        <span class="keyword">bool</span> <span class="identifier">keep_alive</span> <span class="special">=</span> <span class="identifier">response</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">();</span>
        <span class="identifier">response</span><span class="special">.</span><span class="identifier">version</span><span class="special">(</span><span class="identifier">request</span><span class="special">.</span><span class="identifier">version</span><span class="special">());</span>
        <span class="identifier">response</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">(</span><span class="identifier">keep_alive</span><span class="special">);</span>
        <span class="identifier">response</span><span class="special">.</span><span class="identifier">prepare_payload</span><span class="special">();</span>

        <span class="comment">// Send the response</span>
        <span class="identifier">co_await</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">async_write</span><span class="special">(</span><span class="identifier">sock</span><span class="special">,</span> <span class="identifier">response</span><span class="special">,</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">cancel_after</span><span class="special">(</span><span class="identifier">timer</span><span class="special">,</span> <span class="number">60</span><span class="identifier">s</span><span class="special">,</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">redirect_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">)));</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="identifier">orders</span><span class="special">::</span><span class="identifier">log_error</span><span class="special">(</span><span class="string">"Error writing HTTP response: "</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="identifier">co_return</span><span class="special">;</span>
        <span class="special">}</span>

        <span class="comment">// This means we should close the connection, usually because</span>
        <span class="comment">// the response indicated the "Connection: close" semantic.</span>
        <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">keep_alive</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="identifier">sock</span><span class="special">.</span><span class="identifier">shutdown</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span><span class="special">::</span><span class="identifier">shutdown_send</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="identifier">co_return</span><span class="special">;</span>
        <span class="special">}</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="special">}</span>  <span class="comment">// namespace</span>

<span class="identifier">asio</span><span class="special">::</span><span class="identifier">awaitable</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span> <span class="identifier">orders</span><span class="special">::</span><span class="identifier">run_server</span><span class="special">(</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">,</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="identifier">port</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// An object that allows us to accept incoming TCP connections</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">acceptor</span> <span class="identifier">acc</span><span class="special">(</span><span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">this_coro</span><span class="special">::</span><span class="identifier">executor</span><span class="special">);</span>

    <span class="comment">// The endpoint where the server will listen. Edit this if you want to</span>
    <span class="comment">// change the address or port we bind to.</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">endpoint</span> <span class="identifier">listening_endpoint</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">make_address</span><span class="special">(</span><span class="string">"0.0.0.0"</span><span class="special">),</span> <span class="identifier">port</span><span class="special">);</span>

    <span class="comment">// Open the acceptor</span>
    <span class="identifier">acc</span><span class="special">.</span><span class="identifier">open</span><span class="special">(</span><span class="identifier">listening_endpoint</span><span class="special">.</span><span class="identifier">protocol</span><span class="special">());</span>

    <span class="comment">// Allow address reuse</span>
    <span class="identifier">acc</span><span class="special">.</span><span class="identifier">set_option</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">socket_base</span><span class="special">::</span><span class="identifier">reuse_address</span><span class="special">(</span><span class="keyword">true</span><span class="special">));</span>

    <span class="comment">// Bind to the server address</span>
    <span class="identifier">acc</span><span class="special">.</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">listening_endpoint</span><span class="special">);</span>

    <span class="comment">// Start listening for connections</span>
    <span class="identifier">acc</span><span class="special">.</span><span class="identifier">listen</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">socket_base</span><span class="special">::</span><span class="identifier">max_listen_connections</span><span class="special">);</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Server listening at "</span> <span class="special">&lt;&lt;</span> <span class="identifier">acc</span><span class="special">.</span><span class="identifier">local_endpoint</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

    <span class="comment">// Start the acceptor loop</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="keyword">true</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// Accept a new connection</span>
        <span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span> <span class="identifier">sock</span> <span class="special">=</span> <span class="identifier">co_await</span> <span class="identifier">acc</span><span class="special">.</span><span class="identifier">async_accept</span><span class="special">();</span>

        <span class="comment">// Function implementing our session logic.</span>
        <span class="comment">// Takes ownership of the socket.</span>
        <span class="comment">// Having this as a named variable workarounds a gcc bug</span>
        <span class="comment">// (https://gcc.gnu.org/bugzilla/show_bug.cgi?id=107288)</span>
        <span class="keyword">auto</span> <span class="identifier">session_logic</span> <span class="special">=</span> <span class="special">[&amp;</span><span class="identifier">pool</span><span class="special">,</span> <span class="identifier">socket</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">sock</span><span class="special">)]()</span> <span class="keyword">mutable</span> <span class="special">{</span>
            <span class="keyword">return</span> <span class="identifier">run_http_session</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">socket</span><span class="special">),</span> <span class="identifier">pool</span><span class="special">);</span>
        <span class="special">};</span>

        <span class="comment">// Launch a new session for this connection. Each session gets its</span>
        <span class="comment">// own coroutine, so we can get back to listening for new connections.</span>
        <span class="identifier">asio</span><span class="special">::</span><span class="identifier">co_spawn</span><span class="special">(</span>
            <span class="comment">// Every session gets its own strand. This prevents data races.</span>
            <span class="identifier">asio</span><span class="special">::</span><span class="identifier">make_strand</span><span class="special">(</span><span class="identifier">co_await</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">this_coro</span><span class="special">::</span><span class="identifier">executor</span><span class="special">),</span>

            <span class="comment">// The actual coroutine</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">session_logic</span><span class="special">),</span>

            <span class="comment">// Callback to run when the coroutine finishes</span>
            <span class="special">[](</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">exception_ptr</span> <span class="identifier">ptr</span><span class="special">)</span> <span class="special">{</span>
                <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ptr</span><span class="special">)</span>
                <span class="special">{</span>
                    <span class="comment">// For extra safety, log the exception but don't propagate it.</span>
                    <span class="comment">// If we failed to anticipate an error condition that ends up raising an exception,</span>
                    <span class="comment">// terminate only the affected session, instead of crashing the server.</span>
                    <span class="keyword">try</span>
                    <span class="special">{</span>
                        <span class="identifier">std</span><span class="special">::</span><span class="identifier">rethrow_exception</span><span class="special">(</span><span class="identifier">ptr</span><span class="special">);</span>
                    <span class="special">}</span>
                    <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span><span class="special">&amp;</span> <span class="identifier">exc</span><span class="special">)</span>
                    <span class="special">{</span>
                        <span class="keyword">auto</span> <span class="identifier">guard</span> <span class="special">=</span> <span class="identifier">lock_cerr</span><span class="special">();</span>
                        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"Uncaught error in a session: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">exc</span><span class="special">.</span><span class="identifier">what</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
                    <span class="special">}</span>
                <span class="special">}</span>
            <span class="special">}</span>
        <span class="special">);</span>
    <span class="special">}</span>
<span class="special">}</span>
</pre>
</div>
<div class="copyright-footer">Copyright © 2019-2024 Ruben Perez<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="pipeline.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="http_server_cpp14_coroutines.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
